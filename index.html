<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&display=swap" rel="stylesheet">
  <title>Wordsearch Puzzle</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }

    #grid {
      display: grid;
      grid-gap: 2px;
      justify-content: center;
      margin: 20px 0;
    }

    .cell {
      width: 30px;
      height: 30px;
      background-color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
      user-select: none;
    }

    .selected {
      background-color: #fff5b1;
      box-shadow: inset 0 0 4px #f4d06f;
    }

    .found {
      background-color: #90ee90;
    }

    #word-list {
      margin-bottom: 10px;
    }

    .found-word {
      text-decoration: line-through;
      color: gray;
    }

    #wordsearch-app {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        border: 4px solid #ccc;
        border-radius: 16px;
        background-color: #fafafa;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    #controls {
        margin-bottom: 10px;
    }

    #grid-shell {
      display: flex;
      justify-content: center;
      overflow-x: auto;
      padding: 8px;
      max-width: 100vw;
    }
    
    #grid-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 8px;
      flex-wrap: wrap;
    }

    #game-title img {
      height: 200px;
      width: auto;
      display: block;
      margin: 0 auto;
    }

    #puzzle-fact {
      margin-top: 20px;
      padding: 14px 16px;
      border-radius: 12px;
      background: linear-gradient(to bottom right, #fffdf6, #fdf6e3);
      color: #5e4a32;
      font-family: 'Coming Soon', cursive;
      font-size: 1.05em;
      font-style: italic;
      line-height: 1.5;
      border: 2px dotted #dbc196;
      box-shadow: 0 2px 6px rgba(180, 160, 100, 0.1);
      position: relative;
      transition: transform 0.2s ease;
    }

    #congrats-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 1em;
        font-weight: bold;
        color: #4b0082;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
        z-index: 10;
        pointer-events: none;
        text-align: center;
        white-space: nowrap;         /* üí• Force single line */
        max-width: none;             /* üí• Don‚Äôt cap the width */
    }

    @keyframes pop {
        0% { transform: scale(0.6); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    #wordsearch-app h1 {
        font-family: 'Segoe UI', 'Quicksand', 'Comic Neue', sans-serif;
        font-size: 2.5em;
        font-weight: 700;
        color: #ab84d8; /* soft purple */
        text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.6);
        margin-bottom: 20px;
        text-align: center;
    }

    @keyframes shine {
        0% { background-position: 0% }
        100% { background-position: 100% }
    }

    #wordling-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
    }

    .header-wordling {
      width: 48px;
      height: auto;
    }

    #wordling-row {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .wordling-row-img {
        width: 48px;
        height: 48px;
        object-fit: contain;
        display: inline-block;
        animation: pop-in 0.4s ease;
        user-select: none;
    }

    #cosplay-section {
      margin-top: 20px;
      text-align: center;
      background: #f7f7ff;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(180, 180, 255, 0.2);
    }
    
    #cosplay-wordling-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      padding-top: 10px;
    }

    #hidden-word {
        text-align: center;
        color: #444;
        font-size: 1em;
    }

    @keyframes sparkle {
      0% {
        transform: scale(1);
        text-shadow: none;
      }
      25% {
        transform: scale(1.1);
        text-shadow: 0 0 6px #fff8dc, 0 0 10px #b3f4d6;
      }
      50% {
        transform: scale(1);
        text-shadow: none;
      }
      75% {
        transform: scale(1.05);
        text-shadow: 0 0 4px #fff8dc;
      }
      100% {
        transform: scale(1);
        text-shadow: none;
      }
    }
    
    .sparkle {
      animation: sparkle 0.8s ease-in-out;
    }

    .wordling-pop {
      position: absolute;
      width: 40px;
      height: auto;
      animation: wordling-pop 1.2s ease-out;
      z-index: 20;
      pointer-events: none;
    }
    
    @keyframes wordling-pop {
      0%   { transform: scale(0.2); opacity: 0; }
      40%  { transform: scale(1.2); opacity: 1; }
      80%  { transform: scale(1); }
      100% { opacity: 0; transform: scale(0.9); }
    }

    @media (max-width: 600px) {
      #grid {
        font-size: 1em;;
        gap: 4px;
        margin: 0 auto;
      }

      #grid-shell {
        display: flex;
        justify-content: flex-start;
        overflow-x: hidden;
        padding: 8px;
        width: 100%;
        max-width: 100vw;
        scrollbar-width: thin;
        scrollbar-color: #b5e0ca #f3f3f3; /* pastel green on soft background */
        box-sizing: border-box;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
      }

      #grid-shell::-webkit-scrollbar {
        height: 8px;
      }
    
      #grid-shell::-webkit-scrollbar-track {
        background: #f3f3f3;
        border-radius: 4px;
      }
    
      #grid-shell::-webkit-scrollbar-thumb {
        background-color: #b5e0ca;
        border-radius: 4px;
      }
    
      #grid-shell::-webkit-scrollbar-thumb:hover {
        background-color: #94cfb4;
      }

      #grid-shell::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        width: 16px;
        background: linear-gradient(to right, transparent, rgba(0,0,0,0.05));
        pointer-events: none;
      }
      
      #grid-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 8px;
        flex-wrap: wrap;
      }
      
      .cell {
        width: 26px;
        height: 26px;
      }
      
      select,
      button {
        font-size: 1.2em;
        padding: 10px 16px;
        border-radius: 8px;
      }
      
      #wordlist-select, #size-select {
        width: 100%;
        margin-bottom: 10px;
      }
      
      #wordling-row {
        overflow-x: auto;
        white-space: nowrap;
        justify-content: flex-start;
        padding: 10px 6px;
        scroll-snap-type: x mandatory;
      }
      
      .wordling-row-img {
        scroll-snap-align: center;
      }
      
      #grid-container.zoom-out {
        transform: scale(0.95);
      }
    
      .cell {
        width: 26px;
        height: 26px;
      }
    
      /* For large grids, squeeze more */
      .cell.big-grid {
        width: 22px;
        height: 22px;
      }

    }
  </style>

</head>

<body>
    <div id="wordsearch-app">
        <div id="wordling-header">
          <div id="game-title">
            <img src="images/wordling-title.png" alt="Wordling Search Logo" />
          </div>
        </div>
    
        <div id="controls">
            <label for="size-select">Grid Size:</label>
            <select id="size-select">
                <option value="8">8√ó8</option>
                <option value="10" selected>10√ó10</option>
                <option value="12">12√ó12</option>
            </select>
    
            <label for="wordlist-select" style="margin-left: 10px;">Word List:</label>
            <select id="wordlist-select">
                <option value="fruits">üçì Fruits</option>
                <option value="animals">üêØ Animals</option>
                <option value="cozy">üî• Cozy Words</option>
                <option value="gemstones">üíé Gemstones</option>
                <option value="miku">üåü Hatsune Miku</option>
                <option value="mikusongs">üé§ Hatsune Miku Songs</option>
            </select>
    
            <button id="new-game-btn" style="margin-left: 10px;">New Puzzle</button>
        </div>
    
        <div id="word-list"></div>
        <div id="hidden-word" style="margin-top: 10px; font-style: italic;">
            <strong>Hidden Word:</strong> <span id="hidden-word-value">(still hiding...)</span>
        </div>

        <div id="grid-shell">
          <div id="grid-container" style="position: relative; display: inline-block;">
              <div id="grid"></div>
              <div id="congrats-overlay" style="display: none;">
                  üåü Puzzle Complete! üåü
              </div>
          </div>
        </div>
        
        <div id="puzzle-fact"></div>

        <div id="wordling-row" style="margin-top: 20px;"></div>
        <div id="cosplay-section">
          <h3>üåü Cosplay Wordlings</h3>
          <div id="cosplay-wordling-row"></div>
        </div>
        <div id="korok-stats" style="margin-top: 10px; font-size: 0.9em; color: #4b0082;">
            üåø Wordlings found: <span id="korok-count">0</span>
        </div>
    </div>

    

    <script>
        const wordLists = {
            fruits: {
                words: ['APPLE', 'BANANA', 'ORANGE', 'KIWI', 'MANGO', 'GRAPE', 'PEAR', 'MELON', 'CHERRY', 'LEMON'],
                facts: [
                  "üçå Harvest Wordlings giggle that bananas are berries‚Ä¶ but strawberries are just pretending!",
                  "üçä Oranges were once so rare in Europe, they were given like treasure during winter festivals.",
                  "üçé Apples are 25% air‚Äîno wonder they float in cider streams and orchard ponds.",
                  "ü•ù Kiwi was once called the ‚ÄòChinese gooseberry‚Äô‚Äîbut it got a cuter name in New Zealand!",
                  "üçá Grapes explode in the microwave‚Ä¶ and the Wordlings kindly ask you not to test this.",
                  "üåπ Cherries bloom with the roses and carry the same perfume in their spring breeze.",
                  "üçê Old pear trees have watched over generations‚Äîthey can live for more than a hundred years!"
                ]
            },
            animals: {
                words: ['CAT', 'DOG', 'PANDA', 'KOALA', 'BUNNY', 'FOX', 'FAWN', 'HEDGEHOG', 'OTTER', 'SLOTH'],
                facts: [
                  "üêæ Otter Wordlings hold paws while napping on riverbeds so they don‚Äôt drift apart.",
                  "üê® Even Koalalings leave behind fingerprints‚Äîsome say they're nearly human.",
                  "ü¶• Slothlings can hold their breath longer than dolphins, just by doing‚Ä¶ nothing.",
                  "ü¶î Hedgehog Wordlings were once called ‚Äòurchins‚Äô in the old forest tongue.",
                  "üêº Pandaling eats bamboo like a herbivore, but hides teeth fit for a tiny carnivore.",
                  "ü¶ä Foxlings have over 40 different sounds, from giggles to ghostly cries.",
                  "ü¶å A fawn can walk within minutes of birth ‚Äî some Wordlings think that‚Äôs magic."
                ]
            },
            cozy: {
                words: ['TEA', 'BLANKET', 'FIREPLACE', 'BOOK', 'CANDLE', 'WINDOW', 'SOCKS', 'COCOA', 'QUILT', 'SLIPPERS'],
                facts: [
                  "üïØÔ∏è Hearthlings remember when candles were made from beeswax or fat‚Äîevery flicker hard-earned.",
                  "üìñ Reading by firelight was once a winter treasure, saved for the longest nights.",
                  "üßµ The oldest known quilt comes from 3400 BC‚ÄîHearthlings say it still dreams in patterns.",
                  "üë£ Slippers were invented in ancient China to make footsteps soft and silent indoors.",
                  "üçµ In the 1800s, tea was so precious it came with a key‚Äîlocked in its own tiny chest.",
                  "üß¶ Wool socks are naturally cozy *and* fight off foot-odor gremlins ‚Äî Hearthling tested."
                ]
            },
            gemstones: {
                words: ['AGATE', 'ALEXANDRITE', 'AMBER', 'AMETHYST', 'APATITE', 'BERYL', 'CHALCEDONY', 'CITRINE', 'CORUNDUM', 'DIAMOND', 'EMERALD', 'GARNET', 'ONYX', 'OPAL', 'PEARL', 'PERIDOT', 'QUARTZ', 'ROSE QUARTZ', 'RUBY', 'SAPPHIRE', 'TOPAZ', 'TOURMALINE', 'TURQUOISE', 'ZIRCON'],
                facts: [
                  "üíé Gemlings say only four stones are called truly precious: diamond, ruby, sapphire, and emerald.",
                  "üåø Amber isn't a stone at all‚Äîit's the ancient memory of trees, hardened into golden glass.",
                  "üß° Some say you can find tiny creatures or petals frozen in amber‚Äôs golden embrace.",
                  "üíú Amethyst's violet glow comes from whispers of iron and sunlight trapped deep inside.",
                  "ü¶∑ Wordlings whisper that Apatite is what teeth dream of becoming.",
                  "üí† Diamond is the hardest truth the earth can speak.",
                  "üî∑ Though diamonds begin pure, a single impurity can turn them blue, brown, or rainbow-touched.",
                  "üîÆ Garnets come in every color‚Äîbut blue ones are so rare that even Gemlings blink twice.",
                  "üíö A tsavorite garnet may not be 'precious,' but it shines with the price of royalty.",
                  "üíß Opals are soft water trapped in stone‚Äîsometimes as much as a fifth of their weight!",
                  "üåà Opals don't follow crystal rules‚Äîthey're pure rainbow chaos.",
                  "ü¶™ Pearls are made by sea-mollusks when they turn irritation into treasure.",
                  "üåø Peridot is what olivine becomes when it gets dressed up for a ball.",
                  "üçè Peridot glows green thanks to iron hiding in its heart.",
                  "üé® Quartz wears many colors‚Äîwhen it's purple, we call it amethyst; when golden, citrine.",
                  "ü™® Pure quartz is clear as truth‚Äîsome call it rock crystal.",
                  "üî• Both ruby and sapphire are born from the same mineral, corundum‚Äîjust dressed in different flames."
                ]
            },
            miku: {
              words: ['HATSUNE MIKU', 'VOCALOID', 'CRYPTON', 'TWINTAILS', 'VIRTUAL', 'IDOL', 'HOLOGRAM', 'SINGER', 'FIRST SOUND', 'FUTURE', 'SAKI FUJITA', 'KEI GARO', 'YAMAHA', 'PHONIC', 'VOICEBANK', 'DANCE', 'SPRING ONION', 'LEEK', 'PROJECT DIVA', 'CHARACTER', 'TURQUOISE', 'ANDROID', 'COMPUTER', 'JAPANESE', 'SYNTHESIZER', 'RHYTHM'],
              facts: [
                "üé§ Idol Wordlings say Miku was the very first voice in a new digital songbook‚ÄîCV-01, the start of it all.",
                "üåü Sometimes, you can catch her performing live in light and holograms, like a dream on stage.",
                "üéôÔ∏è Her voice was woven from Saki Fujita‚Äôs, like sunlight filtered through a synthesizer.",
                "üí´ 'Hatsune Miku' means 'The First Sound of the Future'‚Äîa whisper from tomorrow itself.",
                "üé® Wordlings say her turquoise glow was chosen before anything else‚Äîjust the color, and a dream of music.",
                "üéπ Her shade of turquoise matches the tones of Yamaha‚Äôs magical music machines.",
                "üß§ The glowing sleeve on her arm? It holds echoes of synthesizer lights from long ago.",
                "üó£Ô∏è Miku doesn‚Äôt speak like us‚Äîshe sings in syllables, phonics stitched into melody.",
                "üìÖ Pop Idol Wordlings celebrate her birthday on August 31st, when the songs began again.",
                "ü§ñ Miku was imagined as a future diva in a world where songs had vanished‚Äîbut she brought them back.",
                "üåç She was the first to bring her voice across oceans with Vocaloid 3‚Äôs English library.",
                "üéß At first, she wasn‚Äôt meant for fans at all‚Äîjust for pros. But the world had other plans.",
                "üßÖ Thanks to one silly video, Miku‚Äôs now forever dancing with spring onions and leeks.",
                "üéÆ Sega Wordlings built her a stage in rhythm‚Äîan entire world of beats called Project Diva."
              ]
            },
            mikusongs: {
              words: ['ABSOLUNOTE', 'ACUTE', 'AGEAGE AGAIN', 'AIKOTOBA', 'ALIEN ALIEN', 'BLACK ROCK SHOOTER', 'CANTARELLA', 'CAT FOOD', 'CATCH THE WAVE', 'CENDRILLON', 'DANCE OF MANY', 'DEAR', 'DECORATOR', 'DEEP SEA GIRL', 'DREAMING LEAF', 'DENPARADIGM', 'DRAMATURGY', 'DOUBLEGANGER', 'ELECTRIC ANGEL', 'ENVY CAT WALK', 'FINDER', 'FROM Y TO Y', 'GHOST RULE', 'GIGANTIC GIRL', 'GIZMO', 'HAND IN HAND', 'HIBIKASE', 'HIBANA', 'HIGH SCHOOL DAYS', 'HOLY STAR', 'INNOCENCE', 'INTERVIEWER', 'JITTERBUG', 'KIMI NI', 'KNIFE', 'KNIGHT OF LIGHT', 'LOVE IS WAR', 'LUCID DREAMING', 'MAGNET', 'MARGINAL', 'MASTER OF PUPPETS', 'METEOR', 'MIRACLE PAINT', 'MOON', 'MOUSOU SKETCH', 'NEKOMIMI SWITCH', 'PINK MOON', 'PINKY SWEAR', 'PO PI PO', 'PROMISE', 'PUZZLE', 'ROLLING GIRL', 'ROMEO AND CINDERELLA', 'SAIHATE', 'SAKURA NO AME', 'SECRET POLICE', 'SENBONZAKURA', 'SOUND', 'SLUMP', 'STAR STORY', 'STARDUSTER', 'STARGAZER', 'STEP FORWARD', 'SUMMER IDOL', 'SWEET DEVIL', 'SYSTEMATIC LOVE', 'TELL YOUR WORLD', 'THE FIRST SOUND', 'THE SECRET GARDEN', 'THE WORLD IS MINE', 'TIME LIMIT', 'TIME MACHINE', 'TORINOKOCITY', 'TRICOLORE AIRLINE', 'UNHAPPY REFRAIN', 'VELVET ARABESQUE', 'WEEKENDER GIRL', 'WOLF GIRL', 'YELLOW', 'YUMEYUME'],
              facts: [
                "üé§ Idol Wordlings say Miku was the very first voice in a new digital songbook ‚Äî CV-01, the start of it all.",
                "üåü Sometimes, you can catch her performing live in light and holograms, like a dream on stage.",
                "üéôÔ∏è Her voice was woven from Saki Fujita‚Äôs, like sunlight filtered through a synthesizer.",
                "üí´ 'Hatsune Miku' means 'The First Sound of the Future' ‚Äî a whisper from tomorrow itself.",
                "üé® Wordlings say her turquoise glow was chosen before anything else ‚Äî just the color, and a dream of music.",
                "üéπ Her shade of turquoise matches the tones of Yamaha‚Äôs magical music machines.",
                "üß§ The glowing sleeve on her arm? It holds echoes of synthesizer lights from long ago.",
                "üó£Ô∏è Miku doesn‚Äôt speak like us‚Äîshe sings in syllables, phonics stitched into melody.",
                "üìÖ Pop Idol Wordlings celebrate her birthday on August 31st, when the songs began again.",
                "ü§ñ Miku was imagined as a future diva in a world where songs had vanished ‚Äî but she brought them back.",
                "üåç She was the first to bring her voice across oceans with Vocaloid 3‚Äôs English library.",
                "üéß At first, she wasn‚Äôt meant for fans at all ‚Äî just for pros. But the world had other plans.",
                "üßÖ Thanks to one silly video, Miku‚Äôs now forever dancing with spring onions and leeks.",
                "üéÆ Sega Wordlings built her a stage in rhythm ‚Äî an entire world of beats called Project Diva."
              ]
            },
        };

        const wordlingThemes = {
            fruits: ['wordling1.png', 'wordling2.png', 'wordling3.png', 'wordling4.png'],
            animals: ['wordling1.png', 'wordling2.png', 'wordling3.png', 'wordling4.png'],
            cozy: ['cozy-wordling1.png', 'cozy-wordling2.png'], // reuse is fine!
            gemstones: ['gem-wordling1.png', 'gem-wordling2.png', 'gem-wordling3.png', 'gem-wordling4.png'],
            miku: ['miku-wordling1.png', 'miku-wordling2.png', 'miku-wordling3.png'],
            mikusongs: ['miku-wordling1.png', 'miku-wordling2.png', 'miku-wordling3.png'],
            // add more as you build more puzzles
        };

      const milestoneWordlings = {
        05: 'pirateling.png',
        10: 'ninjaling.png',
        15: 'punchling.png',
        20: 'cyberling.png',
        25: 'mechaling.png',
        30: 'pokeling.png',
        35: 'dekuling.png',
        40: 'moonling.png',
        45: 'gokuling.png',
        50: 'cloudling.png'
      };

        const grid = [];
        let gridSize = 10;
        let words = [];
        let currentPuzzleTheme = 'fruits'; // default
        let bonusWord = ''; // The hidden word
        let korokCount = 0;
        const cellElements = [];
        const directions = [
            [0, 1], [1, 0], [1, 1], [-1, 1]
        ];
        let selectedCells = [];
        let isMouseDown = false;
        let selecting = false;
        let floatingWordling = null;
        let floatingWordlingImage = null;

        const gridShell = document.getElementById('grid-shell');

        if (gridSize >= 12 && window.innerWidth < 600) {
          gridShell.classList.add('show-scroll');
        } else {
          gridShell.classList.remove('show-scroll');
        }

        if (gridSize >= 12) {
          document.querySelectorAll('.cell').forEach(cell => cell.classList.add('big-grid'));
        }
        if (gridSize === 12) {
          document.getElementById('grid-container').classList.add('zoom-out');
        }
  
        function createEmptyGrid() {
            for (let i = 0; i < gridSize; i++) {
                grid[i] = [];
                cellElements[i] = [];
                for (let j = 0; j < gridSize; j++) {
                grid[i][j] = '';
                cellElements[i][j] = null;
                }
            }
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function getCellData(el) {
            return {
                element: el,
                letter: el.textContent,
                row: parseInt(el.dataset.row),
                col: parseInt(el.dataset.col)
            };
        }

        function tryPlacingWords(wordList, maxWords = 12) {
            const placed = [];
            const copy = [...wordList];
            shuffle(copy);
        
            for (let originalWord of copy) {
                const cleanWord = originalWord.replace(/\s+/g, '').toUpperCase();
        
                if (cleanWord.length > gridSize) continue; // skip overly long words
                if (placed.length >= maxWords) break;
        
                if (placeWord(cleanWord)) {
                    placed.push({ display: originalWord, value: cleanWord });
                }
            }
        
            // üåü Add a hidden bonus word (guaranteed)!
            const allWords = wordList.filter(w => !placed.some(p => p.display === w));
            bonusWord = ''; // reset before attempting placement
        
            for (let i = 0; i < allWords.length; i++) {
                const candidate = allWords[i].replace(/\s+/g, '').toUpperCase();
                if (!placed.some(p => p.value === candidate) && placeWord(candidate)) {
                    bonusWord = candidate;
                    break;
                }
            }
        
            // ü™Ñ Optional backup: reuse a placed word if nothing else fits
            if (!bonusWord && placed.length > 0) {
                const fallback = placed[Math.floor(Math.random() * placed.length)];
                bonusWord = fallback.value;
            }
        
            return placed;
        }

        function generatePuzzle() {
            const sizeValue = document.getElementById('size-select').value;
            const listValue = document.getElementById('wordlist-select').value;
            currentPuzzleTheme = listValue; // store the theme globally
            const wordListObj = wordLists[listValue];

            const wordList = wordListObj.words;
            const facts = wordListObj.facts;

            const randomFact = facts[Math.floor(Math.random() * facts.length)];
            document.getElementById('puzzle-fact').textContent = `${randomFact}`;

            document.getElementById('hidden-word-value').textContent = '(still hiding...)';
            if (floatingWordling) {
              floatingWordling.remove();
              floatingWordling = null;
              floatingWordlingImage = null;
            }

            gridSize = parseInt(sizeValue);

            selectedCells = [];
            selectedCells.direction = null;

            createEmptyGrid();
            const maxWords = Math.floor(gridSize * 0.8); // scale with grid size
            words = tryPlacingWords(wordList, maxWords);
            fillEmptyCells();
            renderWordList();
            renderGrid();

            console.log("Placed words:", words.map(w => w.display));
            console.log("Bonus word:", bonusWord);
        }
  
        function placeWord(word) {
            for (let attempts = 0; attempts < 100; attempts++) {
                const dir = directions[Math.floor(Math.random() * directions.length)];
                const row = Math.floor(Math.random() * gridSize);
                const col = Math.floor(Math.random() * gridSize);
        
                let fits = true;
                for (let i = 0; i < word.length; i++) {
                const r = row + dir[0] * i;
                const c = col + dir[1] * i;
                if (r < 0 || r >= gridSize || c < 0 || c >= gridSize || (grid[r][c] && grid[r][c] !== word[i])) {
                    fits = false;
                    break;
                }
                }
        
                if (fits) {
                for (let i = 0; i < word.length; i++) {
                    const r = row + dir[0] * i;
                    const c = col + dir[1] * i;
                    grid[r][c] = word[i];
                }
                return true;
                }
            }
            return false;
        }
  
        function fillEmptyCells() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                if (!grid[i][j]) {
                    grid[i][j] = letters[Math.floor(Math.random() * letters.length)];
                    }
                }
            }
        }
  
        function renderWordList() {
            const listDiv = document.getElementById('word-list');
            listDiv.innerHTML = '<strong>Find these words:</strong><br>' +
                words.map(w => `<span id="word-${w.value}">${w.display}</span>`).join(', ');
        }
  
        function renderGrid() {
            const gridDiv = document.getElementById('grid');
            gridDiv.innerHTML = '';
            gridDiv.style.gridTemplateColumns = `repeat(${gridSize}, 30px)`; // <-- this fixes it!

            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                const cell = document.createElement('div');
                cell.textContent = grid[i][j];
                cell.className = 'cell';
                cell.dataset.row = i;
                cell.dataset.col = j;

                cell.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    isMouseDown = true;
                    clearSelection();
                    selectCell(cell);
                });

                cell.addEventListener('mouseenter', () => {
                    if (isMouseDown) selectCell(cell);
                });

                cell.addEventListener('mouseup', () => {
                    isMouseDown = false;
                    checkSelectedWord();
                });

                cell.addEventListener('touchstart', handleTouchStart, { passive: false });
                cell.addEventListener('touchmove', handleTouchMove, { passive: false });
                cell.addEventListener('touchend', handleTouchEnd);

                gridDiv.appendChild(cell);
                cellElements[i][j] = cell;
                }
            }

            document.body.addEventListener('mouseup', () => {
                isMouseDown = false;
                checkSelectedWord();
            });
        }

        function handleTouchStart(e) {
          e.preventDefault();
          const target = e.target.closest('.cell');
          if (target) {
            selecting = true;
            clearSelection(); // üî• reset any previous selection
            selectCell(target);
          }
        }

        function handleTouchMove(e) {
          e.preventDefault();
          const touch = e.touches[0];
          const target = document.elementFromPoint(touch.clientX, touch.clientY);
          if (target && target.classList.contains('cell') && selecting) {
            selectCell(target); // üî• Use your core function!
          }
        }

        function handleTouchEnd(e) {
          if (selecting) {
            selecting = false;
            checkSelectedWord();
            clearSelection();
            selectedCells = [];
          }
        }
  
        function selectCell(cell) {
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            const last = selectedCells[selectedCells.length - 1];

            // Start with first cell
            if (!last) {
                cell.classList.add('selected');
                selectedCells.push({ row, col, letter: grid[row][col], element: cell });
                return;
            }

            // Undo/backtrack if dragging over previous cell
            if (
                selectedCells.length > 1 &&
                row === selectedCells[selectedCells.length - 2].row &&
                col === selectedCells[selectedCells.length - 2].col
            ) {
                last.element.classList.remove('selected');
                selectedCells.pop();
                return;
            }

            // Already selected elsewhere: ignore
            if (selectedCells.some(c => c.row === row && c.col === col)) return;

            // Lock direction from first two cells
            if (selectedCells.length === 1) {
                const dRow = row - last.row;
                const dCol = col - last.col;
                if ((dRow === 0 && dCol === 0) || Math.abs(dRow) > 1 || Math.abs(dCol) > 1) return;

                selectedCells.direction = [dRow, dCol];
            } else if (selectedCells.direction) {
                // Allow small error margin for direction
                const expectedRow = last.row + selectedCells.direction[0];
                const expectedCol = last.col + selectedCells.direction[1];

                const rowDiff = Math.abs(expectedRow - row);
                const colDiff = Math.abs(expectedCol - col);

                if (rowDiff > 0.2 || colDiff > 0.2) return; // allow slight error
            }

            // Save the original background color so we can restore it
            const previousColor = cell.style.backgroundColor;
            
            cell.classList.add('selected');
            cell.dataset.prevColor = previousColor || ''; // store inline color if any
            cell.style.backgroundColor = ''; // let CSS handle the selected style
            selectedCells.push({ row, col, letter: grid[row][col], element: cell });
        }
        
        function clearSelection() {
            selectedCells.forEach(cell => {
              cell.element.classList.remove('selected');
              if (cell.element.dataset.prevColor) {
                cell.element.style.backgroundColor = cell.element.dataset.prevColor;
                delete cell.element.dataset.prevColor;
              }
            });
            selectedCells = [];
            selectedCells.direction = null; // Reset direction
        }

        function getRandomPastel() {
            const hue = Math.floor(Math.random() * 360);
            return `hsl(${hue}, 70%, 85%)`; // pastel-like
        }

        function createImageWordling(size = 48, theme = 'fruits', returnImageOnly = true) {
            const army = wordlingThemes[theme] || ['wordling1.png'];
            const chosen = army[Math.floor(Math.random() * army.length)];
        
            const img = document.createElement('img');
            img.src = `images/${chosen}`;
            img.alt = 'Wordling';
            img.className = 'wordling-img';
            img.style.width = `${size}px`;
        
            return returnImageOnly ? img : { img, chosen };
        }

        function showWordlingPop(imageFile) {
          // Remove any existing pop-up
          const old = document.getElementById('label-wordling');
          if (old) old.remove();
        
          const label = document.getElementById('hidden-word-value');
          const wordling = document.createElement('img');
          wordling.src = `images/${imageFile}`;
          wordling.classList.add('wordling-pop');
          wordling.id = 'label-wordling';
        
          const labelBox = label.getBoundingClientRect();
        
          // üõ†Ô∏è Define the offsets before using them
          const offsetX = labelBox.left + window.scrollX + labelBox.width + 10;
          const offsetY = labelBox.top + window.scrollY - 10;
        
          wordling.style.left = `${offsetX}px`;
          wordling.style.top = `${offsetY}px`;
        
          document.body.appendChild(wordling);
        
          // Track it
          floatingWordling = wordling;
          floatingWordlingImage = imageFile;
        
          // üéâ Confetti!
          confetti({
            particleCount: 30,
            spread: 60,
            startVelocity: 25,
            origin: {
              x: offsetX / window.innerWidth,
              y: offsetY / window.innerHeight
            }
          });
        }

        function unlockCosplayWordling(imageFile) {
          const cosplayRow = document.getElementById('cosplay-wordling-row');
          const cosplayImg = document.createElement('img');
          cosplayImg.src = `images/${imageFile}`;
          cosplayImg.classList.add('wordling-row-img'); // same style or give it a sparkle class
          
          cosplayRow.appendChild(cosplayImg);
        
          // Optional: burst of celebratory confetti
          confetti({
            particleCount: 80,
            spread: 90,
            origin: { x: 0.5, y: 0.2 }
          });
        
          // Optional: Add message pop-up
          //alert('üéâ You unlocked a Cosplay Wordling!');
        }

        function showKorok() {
            const existingPop = document.getElementById('label-wordling');
            if (existingPop) existingPop.remove();
        
            if (bonusWord) {
                document.getElementById('hidden-word-value').textContent = bonusWord;
            }
        
            const { chosen } = createImageWordling(48, currentPuzzleTheme, false);
            showWordlingPop(chosen); // just shows it ‚Äî we‚Äôll move it later
        }
  
        function checkSelectedWord() {
            if (selectedCells.length === 0) return;
            const word = selectedCells.map(c => c.letter).join('');
            const reversed = word.split('').reverse().join('');

            const match = words.find(w => w.value === word || w.value === reversed);
            const isBonus = word === bonusWord || reversed === bonusWord;

            if (match || isBonus) {
                const pastel = getRandomPastel();
                selectedCells.forEach(c => {
                    c.element.style.backgroundColor = pastel;
                    c.element.classList.add('found');
                });

                if (match) {
                    document.getElementById(`word-${match.value}`).classList.add('found-word');
                }

                if (isBonus) {
                    showKorok();
                }

                checkIfPuzzleComplete();
            }

            clearSelection();
        }

        function moveLabelWordlingToRow() {
          
          if (!floatingWordling || !floatingWordlingImage) return;
        
          // Clean up the label Wordling
          floatingWordling.removeAttribute('id');
          floatingWordling.classList.remove('wordling-pop');
          floatingWordling.classList.add('wordling-row-img');
          floatingWordling.removeAttribute('style');
        
          const row = document.getElementById('wordling-row');
        
          row.appendChild(floatingWordling);

            // ‚úÖ Increment the count ONLY when Wordling actually joins
          korokCount++;
          document.getElementById('korok-count').textContent = korokCount;
        
          // ‚úÖ Check for cosplay unlocks too
          if (milestoneWordlings[korokCount]) {
            unlockCosplayWordling(milestoneWordlings[korokCount]);
          }
        
          // Clear the reference after moving
          floatingWordling = null;
          floatingWordlingImage = null;
        }
        

        function checkIfPuzzleComplete() {
            const found = document.querySelectorAll('.found-word').length;
            if (found === words.length) {
                document.getElementById('congrats-overlay').style.display = 'flex';
                launchConfetti(); // üéâ Right here!
                moveLabelWordlingToRow(); // üåü move the Wordling to the row
                setTimeout(() => {
                    document.getElementById('congrats-overlay').style.display = 'none';
                }, 1500);
            }
        }

        function launchConfetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { x: 0.5, y: 0.5 }
            });
        }
  
        // Run the game
        document.getElementById('new-game-btn').addEventListener('click', generatePuzzle);
        generatePuzzle(); // initial load
    
    </script>
</body>
</html>
