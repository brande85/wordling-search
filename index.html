<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&display=swap" rel="stylesheet">

  <link rel="preload" as="image" href="images/wordling-title.png">
  <link rel="prefetch" as="image" href="images/wordling1.png">
  <link rel="prefetch" as="image" href="images/wordling2.png">
  <link rel="prefetch" as="image" href="images/wordling3.png">
  <link rel="prefetch" as="image" href="images/wordling4.png">
  <link rel="prefetch" as="image" href="images/cozy-wordling1.png">
  <link rel="prefetch" as="image" href="images/cozy-wordling2.png">
  <link rel="prefetch" as="image" href="images/gem-wordling1.png">
  <link rel="prefetch" as="image" href="images/gem-wordling2.png">
  <link rel="prefetch" as="image" href="images/gem-wordling3.png">
  <link rel="prefetch" as="image" href="images/gem-wordling4.png">
  <link rel="prefetch" as="image" href="images/miku-wordling1.png">
  <link rel="prefetch" as="image" href="images/miku-wordling2.png">
  <link rel="prefetch" as="image" href="images/miku-wordling3.png">
  <link rel="prefetch" as="image" href="images/cloudling.png">
  <link rel="prefetch" as="image" href="images/ceciling.png">
  <link rel="prefetch" as="image" href="images/dekuling.png">
  <link rel="prefetch" as="image" href="images/gokuling.png">
  <link rel="prefetch" as="image" href="images/moonling.png">
  <link rel="prefetch" as="image" href="images/pokeling.png">
  <link rel="prefetch" as="image" href="images/squalling.png">
  <link rel="prefetch" as="image" href="images/terraling.png">
  <link rel="prefetch" as="image" href="images/warrioroflightling.png">
  <link rel="prefetch" as="image" href="images/zidaneling.png">
  <link rel="prefetch" as="image" href="images/igneous-wordling.png">
  <link rel="prefetch" as="image" href="images/sedimentary-wordling.png">
  <link rel="prefetch" as="image" href="images/metamorphic-wordling.png">
  
  <title>Wordsearch Puzzle</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }

    #grid {
      display: grid;
      grid-gap: 2px;
      justify-content: center;
      margin: 20px 0;
    }

    .cell {
      width: 30px;
      height: 30px;
      background-color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
      user-select: none;
    }

    .selected {
      background-color: #fff5b1;
      box-shadow: inset 0 0 4px #f4d06f;
    }

    .found {
      background-color: #90ee90;
    }

    #word-list {
      margin-bottom: 10px;
    }

    .found-word {
      text-decoration: line-through;
      color: gray;
    }

    #wordsearch-app {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        border: 4px solid #ccc;
        border-radius: 16px;
        background-color: #fafafa;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    #controls {
        margin-bottom: 10px;
    }

    #grid-shell {
      display: flex;
      justify-content: center;
      overflow-x: auto;
      padding: 8px;
      max-width: 100vw;
    }
    
    #grid-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 8px;
      flex-wrap: wrap;
      position: relative;
    }

    #game-title img {
      height: 200px;
      width: auto;
      display: block;
      margin: 0 auto;
    }

    #puzzle-fact {
      margin-top: 20px;
      padding: 14px 16px;
      border-radius: 12px;
      background: linear-gradient(to bottom right, #fffdf6, #fdf6e3);
      color: #5e4a32;
      font-family: 'Coming Soon', cursive;
      font-size: 1.05em;
      font-style: italic;
      line-height: 1.5;
      border: 2px dotted #dbc196;
      box-shadow: 0 2px 6px rgba(180, 160, 100, 0.1);
      position: relative;
      transition: transform 0.2s ease;
    }

    #congrats-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 1em;
        font-weight: bold;
        color: #4b0082;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
        z-index: 10;
        pointer-events: none;
        text-align: center;
        white-space: nowrap;         /* 💥 Force single line */
        max-width: none;             /* 💥 Don’t cap the width */
    }

    #interaction-blocker {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: 2;
      display: none;
    }

    .grid-disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    @keyframes pop {
        0% { transform: scale(0.6); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    #wordsearch-app h1 {
        font-family: 'Segoe UI', 'Quicksand', 'Comic Neue', sans-serif;
        font-size: 2.5em;
        font-weight: 700;
        color: #ab84d8; /* soft purple */
        text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.6);
        margin-bottom: 20px;
        text-align: center;
    }

    @keyframes shine {
        0% { background-position: 0% }
        100% { background-position: 100% }
    }

    #wordling-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .header-wordling {
      width: 48px;
      height: auto;
    }

    #wordling-row {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .wordling-row-img {
        width: 48px;
        height: 48px;
        object-fit: contain;
        display: inline-block;
        animation: pop-in 0.4s ease;
        user-select: none;
    }

    #cosplay-section {
      margin-top: 20px;
      text-align: center;
      background: #f7f7ff;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(180, 180, 255, 0.2);
    }
    
    #cosplay-wordling-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      padding-top: 10px;
    }

    #hidden-word {
        text-align: center;
        color: #444;
        font-size: 1em;
    }

    .hint-text {
      font-family: 'Coming Soon', cursive;
      font-size: 0.9em;
      color: #5c4033;
      text-align: center;
      margin-bottom: 8px;
      opacity: 0.8;
    }

    @keyframes sparkle {
      0% {
        transform: scale(1);
        text-shadow: none;
      }
      25% {
        transform: scale(1.1);
        text-shadow: 0 0 6px #fff8dc, 0 0 10px #b3f4d6;
      }
      50% {
        transform: scale(1);
        text-shadow: none;
      }
      75% {
        transform: scale(1.05);
        text-shadow: 0 0 4px #fff8dc;
      }
      100% {
        transform: scale(1);
        text-shadow: none;
      }
    }
    
    .sparkle {
      animation: sparkle 0.8s ease-in-out;
    }

    .wordling-pop {
      position: absolute;
      width: 40px;
      height: auto;
      animation: wordling-pop 1.2s ease-out;
      z-index: 20;
      pointer-events: none;
    }
    
    @keyframes wordling-pop {
      0%   { transform: scale(0.2); opacity: 0; }
      40%  { transform: scale(1.2); opacity: 1; }
      80%  { transform: scale(1); }
      100% { opacity: 0; transform: scale(0.9); }
    }

    @media (max-width: 600px) {
      #grid {
        font-size: 1em;;
        gap: 4px;
        margin: 0 auto;
      }

      #grid-shell {
        display: flex;
        justify-content: flex-start;
        overflow-x: hidden;
        padding: 8px;
        width: 100%;
        max-width: 100vw;
        scrollbar-width: thin;
        scrollbar-color: #b5e0ca #f3f3f3; /* pastel green on soft background */
        box-sizing: border-box;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
      }

      #grid-shell::-webkit-scrollbar {
        height: 8px;
      }
    
      #grid-shell::-webkit-scrollbar-track {
        background: #f3f3f3;
        border-radius: 4px;
      }
    
      #grid-shell::-webkit-scrollbar-thumb {
        background-color: #b5e0ca;
        border-radius: 4px;
      }
    
      #grid-shell::-webkit-scrollbar-thumb:hover {
        background-color: #94cfb4;
      }

      #grid-shell::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        width: 16px;
        background: linear-gradient(to right, transparent, rgba(0,0,0,0.05));
        pointer-events: none;
      }
      
      #grid-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 8px;
        flex-wrap: wrap;
      }
      
      .cell {
        width: 26px;
        height: 26px;
      }
      
      select,
      button {
        font-size: 1.2em;
        padding: 10px 16px;
        border-radius: 8px;
      }
      
      #wordlist-select, #size-select {
        width: 100%;
        margin-bottom: 10px;
      }
      
      #wordling-row {
        overflow-x: auto;
        white-space: nowrap;
        justify-content: flex-start;
        padding: 10px 6px;
        scroll-snap-type: x mandatory;
      }
      
      .wordling-row-img {
        scroll-snap-align: center;
      }
      
      #grid-container.zoom-out {
        transform: scale(0.95);
      }
    
      .cell {
        width: 26px;
        height: 26px;
      }
    
      /* For large grids, squeeze more */
      .cell.big-grid {
        width: 22px;
        height: 22px;
      }

    }
  </style>

</head>

<body>
    <div id="wordsearch-app">
        <div id="wordling-header">
          <div id="game-title">
            <img src="images/wordling-title.png" alt="Wordling Search Logo" />
          </div>
        </div>
    
        <div id="controls">
            <label for="size-select">Grid Size:</label>
            <select id="size-select">
                <option value="8">8×8</option>
                <option value="10" selected>10×10</option>
                <option value="12">12×12</option>
            </select>
    
            <label for="wordlist-select" style="margin-left: 10px;">Word List:</label>
            <select id="wordlist-select">
                <optgroup label="🐾 Animals">
                  <option value="domesticAnimals">🐰 Domestic Animals</option>
                <optgroup label="🍎 Food">
                  <option value="fruits">🍓 Fruits</option>
                <optgroup label="🌍 Geology">
                  <option value="gemstones">💎 Gemstones</option>
                  <option value="igneousRocks">🌋 Igneous Rocks</option>
                  <option value="metamorphicRocks">🪨 Metamorphic Rocks</option>
                  <option value="sedimentaryRocks">⌛ Sedimentary Rocks</option>
                <optgroup label="🎵 Music">
                  <option value="miku">🌟 Hatsune Miku</option>
                  <option value="mikusongs">🎤 Hatsune Miku Songs</option>
                <optgroup label="📜 Other">
                  <option value="cozy">🔥 Cozy Words</option>
            </select>
    
            <button id="new-game-btn" style="margin-left: 10px;">New Puzzle</button>
        </div>
    
        <div id="word-list"></div>
        <div id="hidden-word" style="margin-top: 10px; font-style: italic;">
            <strong>Hidden Word:</strong> <span id="hidden-word-value">(still hiding...)</span>
        </div>

        <div id="grid-shell">
          <div id="grid-container" style="position: relative; display: inline-block;">
              <div id="grid"></div>
              <div id="congrats-overlay" style="display: none;">
                  🌟 Puzzle Complete! 🌟
              </div>
              <div id="interaction-blocker"></div>
          </div>
        </div>
        
        <div id="puzzle-fact"></div>

        <div id="wordling-row" style="margin-top: 20px;">
          <p id="army-empty" class="hint-text">You haven't found any wordlings yet...</p>
        </div>
        <div id="cosplay-section">
          <h3>🌟 Cosplay Wordlings</h3>
          <div id="cosplay-wordling-row">
            <p id="cosplay-empty" class="hint-text">Find 5 wordlings to unlock!</p>
          </div>
        </div>
        <div id="korok-stats" style="margin-top: 10px; font-size: 0.9em; color: #4b0082;">
            🌿 Wordlings found: <span id="korok-count">0</span>
        </div>
    </div>
  
    

    <script>
        const wordLists = {
            fruits: {
                words: ['APPLE', 'BANANA', 'ORANGE', 'KIWI', 'MANGO', 'GRAPE', 'PEAR', 'MELON', 'CHERRY', 'LEMON', 'APRICOT', 'AVOCADO', 'BLACKBERRY', 'BLUEBERRY', 'BOYSENBERRY', 'CITRON', 'COCONUT', 'CRANBERRY', 'CURRANT', 'DATE', 'DRAGONFRUIT', 'DURIAN', 'ELDERBERRY', 'FIG', 'LIME', 'GOOSEBERRY', 'GRAPEFRUIT', 'GUAVA', 'JACKFRUIT', 'PLUM', 'KUMQUAT', 'LYCHEE', 'CANTALOUPE', 'HONEYDEW', 'WATERMELON', 'NECTARINE', 'CLEMENTINE', 'TANGERINE', 'PAPAYA', 'PASSIONFRUIT', 'PEACH', 'PERSIMMON', 'PINEAPPLE', 'POMEGRANATE', 'POMELO', 'QUINCE', 'RASPBERRY', 'STRAWBERRY', 'YUZU'],
                facts: [
                  "🍌 Harvest Wordlings giggle that bananas are berries… but strawberries are just pretending!",
                  "🍊 Oranges were once so rare in Europe, they were given like treasure during winter festivals.",
                  "🍎 Apples are 25% air—no wonder they float in cider streams and orchard ponds.",
                  "🥝 Kiwi was once called the ‘Chinese gooseberry’—but it got a cuter name in New Zealand!",
                  "🍇 Grapes explode in the microwave… and the Wordlings kindly ask you not to test this.",
                  "🌹 Cherries bloom with the roses and carry the same perfume in their spring breeze.",
                  "🍐 Old pear trees have watched over generations—they can live for more than a hundred years!",
                  "🍋 In the misty orchards of East Asia, yuzus glow like lemons, but their taste is a whisper of floral lime and morning breeze.",
                  "🍓 Raspberries are made of many tiny pieces, each holding hands to form the whole — like a fruit that grew from a gathering.",
                  "🍐 A quince is stubborn and sour until softened by time or fire — a fruit that must be earned, not taken.",
                  "🍊 Pomelos are the gentle giants of the citrus grove, nearly ten inches wide and heavy with mellow sweetness.",
                  "🌺 In Armenian stories, pomegranates hold seeds of life, luck, and love — one fruit, many blessings.",
                  "🌸 Some plum trees cannot bloom alone. Without a nearby friend, their flowers go unanswered and bear no fruit.",
                  "🍍 Pineapples got their name from explorers who saw pinecones and tasted paradise — and the name stuck like sunlight on skin.",
                  "🍑 Take the fuzz off a peach and you’re left with a nectarine — just as sweet, just a little smoother.",
                  "🌶️ The seeds of a papaya carry a peppery surprise, sharp enough to stand in for black peppercorns at any table.",
                  "🍉 In parts of Japan, watermelons are grown in shapes: hearts for romance, squares for shelves — a fruit made whimsical.",
                  "🍬 Lychee seeds must be left behind; though the fruit is soft and fragrant, the seed carries danger at its core.",
                  "🌞 A guava holds five times the sunshine of an orange — bursting with brightness in every bite.",
                  "⚠️ Grapefruits carry warnings. Their juice can twist the power of medicine, so potions and fruit must be chosen wisely.",
                  "🌰 A fig’s flower lives inside the fruit — hidden, secret, only seen when the fig is opened like a little lantern.",
                  "🚫 The durian’s smell is so strong that hotels and trains ask it to stay outside, no matter how sweet its heart may be.",
                  "🌴 Date trees wear long feather-like fronds and stretch toward desert skies, dreaming of oasis winds.",
                  "🐉 Dragonfruit earned its name from armor and scales — leathery skin and spikes like something from a myth.",
                  "🥥 Coconuts are patient voyagers. They float across oceans for up to 110 days, looking for soft sand and new beginnings.",
                  "🍒 Cranberries are called superfruits — not for flying, but for brimming with little strengths: vitamins, color, and courage."
                ]
            },
            domesticAnimals: {
                words: ['ALPACA', 'CAMEL', 'CHICKEN', 'DONKEY', 'GOAT', 'MINK', 'CATTLE', 'CAT', 'DOG', 'FERRET', 'HORSE', 'PIG', 'RABBIT', 'WATER BUFFALO', 'SILVER FOX', 'SHEEP', 'YAK', 'MOUSE', 'RAT', 'HEDGEHOG', 'LLAMA', 'DOVE', 'CANARY', 'COCKATIEL', 'DUCK', 'GOOSE', 'PIGEON', 'TURKEY', 'GUINEAFOWL', 'HONEY BEE', 'SILKMOTH', 'GOLDFISH', 'KOI', 'GUINEA PIG'],
                facts: [
                  "🐕 Dogs were the first to walk beside us — a friendship older than any written word.",
                  "🍞 After so many meals together, dogs can thrive on bread and stew, unlike their wild cousins.",
                  "🐏 Once, all sheep wore earth tones, but we taught them to grow fleeces white as snow or dark as twilight.",
                  "🐖 Pigs cannot sweat, so they cool off in puddles and shade — clever comfort-seekers.",
                  "🐄 The cow’s story is written deep in its genes — one of the first to have a fully-mapped genome.",
                  "🐈 A cat’s front limbs are bound by floating bones, letting them slip through any place their whiskers fit.",
                  "🧀 Neolithic farmers kept goats for milk and meat, and their bell calls still echo through the hills.",
                  "🥚 A hardworking hen can give over 300 eggs in a single turning of the seasons.",
                  "🐴 Ten donkeys were once buried with a pharaoh, as if honored like noble humans.",
                  "🦆 Ducklings don’t make their own waterproofing — they borrow their mother’s oil for their fluffy adventures.",
                  "🐫 Dromedary camels can survive losing more than 30% of their water — and keep walking.",
                  "🐝 Honeybees dance and scent the air with messages only other bees can read.",
                  "🐎 Horses nap standing or curled on the ground, choosing comfort or watchfulness as needed.",
                  "🕸️ Sericulture is the gentle craft of raising silkworms for threads softer than breath.",
                  "🕊️ Pigeons have lived with humans since Mesopotamia, over five thousand years ago.",
                  "🪿 During a quiet pandemic patrol, geese once stood watch at a border with Vietnam — wings flared like guards.",
                  "🐂 Yaks don’t moo — they grunk and squeak, like old boots and hidden horns.",
                  "🦙 Llamas bring calm to those in pain, quietly visiting hospitals as certified therapy animals.",
                  "🐑 Alpacas are separated not by sound or stride, but by their wool — some curly, some straight.",
                  "🍗 Guineafowl can stand in for chicken in a stew, and some say they bring even more flavor.",
                  "🎯 Ferrets were once sport companions, hunting rabbits through tunnels in a tradition called rabbiting.",
                  "🎩 White doves flutter through magic acts and ceremonies, bringing softness and illusion together.",
                  "🐟 Goldfish released into the wild grow bold and large — so much that they become invaders.",
                  "🐇 Rabbits hopped into human lives when the Romans first invited them indoors.",
                  "🎏 Koi are the bright-painted variant of humble carp, swimming not for food but for beauty.",
                  "🐁 A ‘fancy mouse’ is one bred for show — tiny, whiskered, and well-groomed for pageantry.",
                  "🦦 Some still debate whether domestic mink are truly tamed, or only wearing the mask of calm.",
                  "🦊 Silver foxes were born from experiments that asked how wild things become our companions.",
                  "🦔 In ancient Greece, hedgehogs were welcomed inside homes to eat the insects no one else wanted."
                ]
            },
            cozy: {
                words: ['TEA', 'BLANKET', 'FIREPLACE', 'BOOK', 'CANDLE', 'WINDOW', 'SOCKS', 'COCOA', 'QUILT', 'SLIPPERS'],
                facts: [
                  "🕯️ Hearthlings remember when candles were made from beeswax or fat—every flicker hard-earned.",
                  "📖 Reading by firelight was once a winter treasure, saved for the longest nights.",
                  "🧵 The oldest known quilt comes from 3400 BC—Hearthlings say it still dreams in patterns.",
                  "👣 Slippers were invented in ancient China to make footsteps soft and silent indoors.",
                  "🍵 In the 1800s, tea was so precious it came with a key—locked in its own tiny chest.",
                  "🧦 Wool socks are naturally cozy *and* fight off foot-odor gremlins — Hearthling tested."
                ]
            },
            gemstones: {
                words: ['AGATE', 'ALEXANDRITE', 'AMBER', 'AMETHYST', 'APATITE', 'BERYL', 'CHALCEDONY', 'CITRINE', 'CORUNDUM', 'DIAMOND', 'EMERALD', 'GARNET', 'ONYX', 'OPAL', 'PEARL', 'PERIDOT', 'QUARTZ', 'ROSE QUARTZ', 'RUBY', 'SAPPHIRE', 'TOPAZ', 'TOURMALINE', 'TURQUOISE', 'ZIRCON'],
                facts: [
                  "💎 Gemlings say only four stones are called truly precious: diamond, ruby, sapphire, and emerald.",
                  "🌿 Amber isn't a stone at all—it's the ancient memory of trees, hardened into golden glass.",
                  "🧡 Some say you can find tiny creatures or petals frozen in amber’s golden embrace.",
                  "💜 Amethyst's violet glow comes from whispers of iron and sunlight trapped deep inside.",
                  "🦷 Wordlings whisper that Apatite is what teeth dream of becoming.",
                  "💠 Diamond is the hardest truth the earth can speak.",
                  "🔷 Though diamonds begin pure, a single impurity can turn them blue, brown, or rainbow-touched.",
                  "🔮 Garnets come in every color—but blue ones are so rare that even Gemlings blink twice.",
                  "💚 A tsavorite garnet may not be 'precious,' but it shines with the price of royalty.",
                  "💧 Opals are soft water trapped in stone—sometimes as much as a fifth of their weight!",
                  "🌈 Opals don't follow crystal rules—they're pure rainbow chaos.",
                  "🦪 Pearls are made by sea-mollusks when they turn irritation into treasure.",
                  "🌿 Peridot is what olivine becomes when it gets dressed up for a ball.",
                  "🍏 Peridot glows green thanks to iron hiding in its heart.",
                  "🎨 Quartz wears many colors—when it's purple, we call it amethyst; when golden, citrine.",
                  "🪨 Pure quartz is clear as truth—some call it rock crystal.",
                  "🔥 Both ruby and sapphire are born from the same mineral, corundum—just dressed in different flames."
                ]
            },
            miku: {
              words: ['HATSUNE MIKU', 'VOCALOID', 'CRYPTON', 'TWINTAILS', 'VIRTUAL', 'IDOL', 'HOLOGRAM', 'SINGER', 'FIRST SOUND', 'FUTURE', 'SAKI FUJITA', 'KEI GARO', 'YAMAHA', 'PHONIC', 'VOICEBANK', 'DANCE', 'SPRING ONION', 'LEEK', 'PROJECT DIVA', 'CHARACTER', 'TURQUOISE', 'ANDROID', 'COMPUTER', 'JAPANESE', 'SYNTHESIZER', 'RHYTHM'],
              facts: [
                "🎤 Idol Wordlings say Miku was the very first voice in a new digital songbook—CV-01, the start of it all.",
                "🌟 Sometimes, you can catch her performing live in light and holograms, like a dream on stage.",
                "🎙️ Her voice was woven from Saki Fujita’s, like sunlight filtered through a synthesizer.",
                "💫 'Hatsune Miku' means 'The First Sound of the Future'—a whisper from tomorrow itself.",
                "🎨 Wordlings say her turquoise glow was chosen before anything else—just the color, and a dream of music.",
                "🎹 Her shade of turquoise matches the tones of Yamaha’s magical music machines.",
                "🧤 The glowing sleeve on her arm? It holds echoes of synthesizer lights from long ago.",
                "🗣️ Miku doesn’t speak like us—she sings in syllables, phonics stitched into melody.",
                "📅 Pop Idol Wordlings celebrate her birthday on August 31st, when the songs began again.",
                "🤖 Miku was imagined as a future diva in a world where songs had vanished—but she brought them back.",
                "🌍 She was the first to bring her voice across oceans with Vocaloid 3’s English library.",
                "🎧 At first, she wasn’t meant for fans at all—just for pros. But the world had other plans.",
                "🧅 Thanks to one silly video, Miku’s now forever dancing with spring onions and leeks.",
                "🎮 Sega Wordlings built her a stage in rhythm—an entire world of beats called Project Diva."
              ]
            },
            mikusongs: {
              words: ['ABSOLUNOTE', 'ACUTE', 'AGEAGE AGAIN', 'AIKOTOBA', 'ALIEN ALIEN', 'BLACK ROCK SHOOTER', 'CANTARELLA', 'CAT FOOD', 'CATCH THE WAVE', 'CENDRILLON', 'DANCE OF MANY', 'DEAR', 'DECORATOR', 'DEEP SEA GIRL', 'DREAMING LEAF', 'DENPARADIGM', 'DRAMATURGY', 'DOUBLEGANGER', 'ELECTRIC ANGEL', 'ENVY CAT WALK', 'FINDER', 'FROM Y TO Y', 'GHOST RULE', 'GIGANTIC GIRL', 'GIZMO', 'HAND IN HAND', 'HIBIKASE', 'HIBANA', 'HIGH SCHOOL DAYS', 'HOLY STAR', 'INNOCENCE', 'INTERVIEWER', 'JITTERBUG', 'KIMI NI', 'KNIFE', 'KNIGHT OF LIGHT', 'LOVE IS WAR', 'LUCID DREAMING', 'MAGNET', 'MARGINAL', 'MASTER OF PUPPETS', 'METEOR', 'MIRACLE PAINT', 'MOON', 'MOUSOU SKETCH', 'NEKOMIMI SWITCH', 'PINK MOON', 'PINKY SWEAR', 'PO PI PO', 'PROMISE', 'PUZZLE', 'ROLLING GIRL', 'ROMEO AND CINDERELLA', 'SAIHATE', 'SAKURA NO AME', 'SECRET POLICE', 'SENBONZAKURA', 'SOUND', 'SLUMP', 'STAR STORY', 'STARDUSTER', 'STARGAZER', 'STEP FORWARD', 'SUMMER IDOL', 'SWEET DEVIL', 'SYSTEMATIC LOVE', 'TELL YOUR WORLD', 'THE FIRST SOUND', 'THE SECRET GARDEN', 'THE WORLD IS MINE', 'TIME LIMIT', 'TIME MACHINE', 'TORINOKOCITY', 'TRICOLORE AIRLINE', 'UNHAPPY REFRAIN', 'VELVET ARABESQUE', 'WEEKENDER GIRL', 'WOLF GIRL', 'YELLOW', 'YUMEYUME'],
              facts: [
                "🎤 Idol Wordlings say Miku was the very first voice in a new digital songbook — CV-01, the start of it all.",
                "🌟 Sometimes, you can catch her performing live in light and holograms, like a dream on stage.",
                "🎙️ Her voice was woven from Saki Fujita’s, like sunlight filtered through a synthesizer.",
                "💫 'Hatsune Miku' means 'The First Sound of the Future' — a whisper from tomorrow itself.",
                "🎨 Wordlings say her turquoise glow was chosen before anything else — just the color, and a dream of music.",
                "🎹 Miku's shade of turquoise matches the tones of Yamaha’s magical music machines.",
                "🧤 The glowing sleeve on Miku's arm? It holds echoes of synthesizer lights from long ago.",
                "🗣️ Miku doesn’t speak like us—she sings in syllables, phonics stitched into melody.",
                "📅 Pop Idol Wordlings celebrate Miku's birthday on August 31st, when the songs began again.",
                "🤖 Miku was imagined as a future diva in a world where songs had vanished — but she brought them back.",
                "🌍 Miku was the first to bring her voice across oceans with Vocaloid 3’s English library.",
                "🎧 At first, she wasn’t meant for fans at all — just for pros. But the world had other plans.",
                "🧅 Thanks to one silly video, Miku’s now forever dancing with spring onions and leeks.",
                "🎮 Sega Wordlings built her a stage in rhythm — an entire world of beats called Project Diva."
              ]
            },
            igneousRocks: {
              words: ['IGNEOUS', 'MOLTEN', 'INTRUSIVE', 'CRYSTALLIZE', 'EXTRUSIVE', 'ERUPT', 'AMORPHOUS', 'BASALT', 'DIORITE', 'TRAP ROCK', 'GABBRO', 'GRANITE', 'OBSIDIAN', 'PERIDOTITE', 'PUMICE', 'RHYOLITE', 'FIRE OPAL', 'UNAKITE', 'WELDED TUFF', 'VOLCANO', 'SCORIA', 'PEGMATITE', 'MAGMA', 'DOLERITE', 'DIABASE', 'DACITE', 'INTRUSION', 'GLASS', 'PLUTONIC', 'HYPABYSSAL', 'COUNTRY ROCK', 'BATHOLITH', 'STOCK', 'LACCOLITH', 'SILL', 'DIKE', 'PHANERITIC', 'APHANITIC', 'PORPHYRY'],
              facts: [
                  "🌋 Igneous rocks are born from fire — they form when molten magma cools and stills into stone.",
                  "🔮 Some igneous rocks form deep beneath the surface, cooling slowly to grow crystals large enough to hold in your hand.",
                  "✨ Some igneous rocks erupt onto the land, cooling quickly in the open air and setting their stories in tiny crystal grains.",
                  "🪞 When lava cools too fast to crystalize, it turns into volcanic glass — smooth, dark, and mirror-like.",
                  "🚧 'Trap rock' is a builder’s name for dark igneous stones used to make roads and sturdy paths.",
                  "🌍 About 15% of the Earth’s land is built from igneous stone — quiet reminders of once-molten origins.",
                  "🔦 Some of these rocks hide riches: veins of tin, tungsten, and other treasured minerals.",
                  "🧱 Most igneous rocks are born deep in the Earth as intrusions — hidden until the land rises or wears away.",
                  "🗻 These intrusions press into the Earth’s crust, wrapped in older rock like secrets waiting to be uncovered.",
                  "🏔️ The hearts of great mountain ranges are often made of ancient intrusive stone, weathered but enduring.",
                  "🌑 When formed deep and long ago, they’re called plutonic — named for the god of the underworld.",
                  "🖤 More than 90% of all volcanic rock is basalt — black and ancient, like cooled midnight.",
                  "🪨 Some basalt cools into long, neat columns — like stone honeycombs in places like Giant’s Causeway.",
                  "🔥 Magma rises through the Earth because it’s lighter than the rock around it — like a bubble seeking sky.",
                  "🔍 In some fine-grained rocks, the crystals are so small they must be studied under a microscope to be known.",
                  "🪵 The rock that surrounds an intrusion is called country rock — it keeps the heat in so magma cools slowly.",
                  "📏 A vast intrusion is called a batholith if it’s enormous, or a stock if it’s merely large.",
                  "🏔️ A laccolith forms a stone dome beneath the surface, fed by a narrow crack called a dike.",
                  "📚 A sill slides in flat between layers of older stone — like a secret page tucked into a book.",
                  "🌘 Hypabyssal rocks form near the surface, fine-grained and quick to settle into solidness.",
                  "🔎 If the crystals are large enough to see without aid, the texture is called phaneritic. If not, it’s aphantic — hidden from plain sight.",
                  "🪄 When large crystals appear in a finer background, the result is a porphyry — like gemstones in velvet.",
                  "⚖️ Igneous rocks are named by their chemistry — how much silica they hold shapes their destiny.",
                  "🪐 Basalt isn’t just found on Earth — it paves the plains of Venus and darkens the stones of Mars.",
                  "🧱 Granite is strong, massive, and unyielding — perfect for walls, counters, and ancient monuments.",
                  "🖤 Obsidian breaks into razor edges, sharp and beautiful — once used to make tools, blades, and quiet weapons.",
                  "❄️ Snowflake obsidian forms when tiny white crystals of cristobalite bloom inside volcanic glass — frozen petals in midnight stone.",
                  "🌬️ Pumice is made of bubbles — lava cooled so quickly it kept the air inside, making a rock that floats like a sponge of stone.",
              ]
          },
      
          sedimentaryRocks: {
              words: ['SEDIMENTARY', 'SEDIMENT', 'CLASTIC', 'CHEMICAL', 'ORGANIC', 'CALICHE', 'PUDDINGSTONE', 'CHALK', 'LIMESTONE', 'CHERT', 'COAL', 'CONGLOMERATE', 'COQUINA', 'FOSSIL', 'DIATOMITE', 'DOLOMITE', 'FLINT', 'ROCK SALT', 'SANDSTONE', 'SHALE', 'SILTSTONE', 'CEMENTATION', 'DETRITUS', 'STRATA', 'BEDDING', 'SEDIMENTOLOGY', 'GRAVEL', 'SAND', 'MUD', 'SILT', 'CLAY', 'BRECCIA', 'MUDROCK', 'EVAPORITE', 'COMPACTION', 'LITHIFICATION', 'DIAGENESIS', 'LAMINATION', 'DUNE', 'RIPPLE', 'BIOTURBATION', 'MATRIX'],
              facts: [
                  "🌍 Sedimentary rocks are storytellers — made in three ways: from fragments, from minerals, or from once-living things.",
                  "🪶 These rocks form slowly as layers of tiny pieces settle and are gently pressed into stone over time.",
                  "🪺 Sediments can come from broken stone or living things left behind — bits of yesterday turned into tomorrow.",
                  "🍃 Geological debris is born from weathered cliffs and crumbled mountains, carried by wind, water, or time.",
                  "📚 Sedimentary rock covers most of the land we walk on, though it's only a thin crust atop the deeper Earth.",
                  "📖 These rocks stack in layers called strata — soft pages in the ancient book of the world.",
                  "🛸 Even Mars, dusty and distant, holds sedimentary rocks — proof that water once moved across its face.",
                  "🌱 From coal to drinking water, sedimentary rocks are quiet holders of treasures we rely on every day.",
                  "🧩 Clastic rocks are built from puzzle pieces of older stones, pressed and glued together by pressure and patience.",
                  "🌾 Loose sediments are named by size — gravel clatters, sand sighs, and mud smooths into stillness.",
                  "🐚 Many limestones are made from the bones of ocean life — coral, mollusks, and tiny drifting creatures.",
                  "🌲 Coal is ancient vegetation, transformed by time and pressure into a rock that still remembers leaves and light.",
                  "🔬 Chert forms from the skeletons of microscopic ocean folk — radiolaria and diatoms, hidden but enduring.",
                  "🌀 Diagenesis is the slow magic of change beneath the surface — transformation without a single breath of air.",
                  "🌊 Coquina is made entirely of broken shells, and can only be born where the waves never rest.",
                  "🦴 Fossils are most often found in sedimentary stone — each one a memory cradled in ancient silt.",
                  "⏳ A fossil’s best chance comes in places where sediment settles quickly and few bacteria sleep.",
                  "🐾 Footprints, burrows, and other marks left behind are called trace fossils — echoes of movement and life.",
                  "🌊 Ripple marks form where water flows — in rivers, on beaches, or in the quiet shifts of tidal flats."
              ]
          },
          
          metamorphicRocks: {
              words: ['METAMOPRHIC', 'FOLIATION', 'ANTHRACITE', 'GNEISS', 'HORNFELS', 'LAPIS LAZULI', 'MARBLE', 'MARIPOSITE', 'NOVACULITE', 'PHYLLITE', 'QUARTZITE', 'SCHIST', 'SKARN', 'SLATE', 'SOAPSTONE', 'METAMORPHISM', 'PROTOLITH', 'INDEX MINERAL', 'THERMAL', 'CATACLASTIC', 'HYDROTHERMAL', 'IMPACT', 'FISSILITY'],
              facts: [
                  "🌀 Metamorphic rocks are born from change — when older stones are transformed by heat, pressure, and time into something entirely new.",
                  "📜 The rock before the change is called a protolith — it might be volcanic, sedimentary, or already a stone shaped by change once before.",
                  "🌍 Some rocks are changed deep within the Earth, others by the slow press of tectonic plates — all shaped in the hidden chambers beneath our feet.",
                  "💎 Certain minerals, called index minerals, act like timekeepers — revealing how hot and how deep a rock’s transformation truly went.",
                  "🔍 Metamorphic rocks often sparkle with larger crystals than they began with — time and pressure coaxed them to grow.",
                  "📚 Many metamorphic stones wear stripes or layers called foliation — a record of stress folded into every line.",
                  "🔲 We name these rocks by their texture and how clearly their layers show — some whisper their history, while others shout.",
                  "🔥 When magma creeps too close, it can bake nearby stone — creating a rim of changed rock through contact metamorphism.",
                  "⏳ Some of Earth’s oldest stones are metamorphic — like the Acasta Gneiss in Canada, which remembers the world over 4 billion years ago.",
                  "🪵 Slate breaks in smooth, even sheets — a gift of structure that made it perfect for roofs, tiles, and chalkboard days.",
                  "🎨 Marble begins as limestone or dolomite, but metamorphosis polishes it into sculpture-ready stone, luminous and strong.",
                  "⚠️ Schist has pronounced lines of weakness — beautiful, yes, but tricky for those building upon it.",
                  "🪓 Quartzite began as sandstone — but time’s pressure turned it so tough that early humans shaped tools from its unyielding surface.",
                  "⚡ Slate, being a fine insulator, once guarded the earliest electric switchboards — keeping sparks at bay with quiet grace.",
                  "🔥 Soapstone, soft and smooth, was carved by Native Americans into bowls, pipes, and ornaments thousands of years ago.",
                  "⛏️ Soapstone was one of the first stones humans quarried — rising close to the surface, asking only to be shaped.",
                  "🌟 In the Gold Rush days, prospectors learned to follow the glitter in mariposite — a green stone often veined with promise."
              ]
          },
        };

        const wordlingThemes = {
            fruits: ['wordling1.png', 'wordling2.png', 'wordling3.png', 'wordling4.png'],
            domesticAnimals: ['wordling1.png', 'wordling2.png', 'wordling3.png', 'wordling4.png'], // reuse is fine!
            cozy: ['cozy-wordling1.png', 'cozy-wordling2.png'], 
            gemstones: ['gem-wordling1.png', 'gem-wordling2.png', 'gem-wordling3.png', 'gem-wordling4.png'],
            miku: ['miku-wordling1.png', 'miku-wordling2.png', 'miku-wordling3.png'],
            mikusongs: ['miku-wordling1.png', 'miku-wordling2.png', 'miku-wordling3.png'],
            igneousRocks: ['gem-wordling1.png', 'gem-wordling2.png', 'gem-wordling3.png', 'gem-wordling4.png', 'igneous-wordling.png'],
            sedimentaryRocks: ['gem-wordling1.png', 'gem-wordling2.png', 'gem-wordling3.png', 'gem-wordling4.png', 'sedimentary-wordling.png'],
            metamorphicRocks: ['gem-wordling1.png', 'gem-wordling2.png', 'gem-wordling3.png', 'gem-wordling4.png', 'metamorphic-wordling.png']
            // add more as you build more puzzles
        };

      const cosplayWordlings = [
        'pokeling.png',
        'dekuling.png',
        'moonling.png',
        'gokuling.png',
        'cloudling.png',
        'ceciling.png',
        'squalling.png',
        'terraling.png',
        'warrioroflightling.png',
        'zidaneling.png',
      ];

        const grid = [];
        let gridSize = 10;
        let words = [];
        let currentPuzzleTheme = 'fruits'; // default
        let bonusWord = ''; // The hidden word
        let korokCount = 0;
        const cellElements = [];
        const directions = [
            [0, 1], [1, 0], [1, 1], [-1, 1]
        ];
        let selectedCells = [];
        let isMouseDown = false;
        let selecting = false;
        let floatingWordling = null;
        let floatingWordlingImage = null;
        let unlockedCosplays = [];

        const gridShell = document.getElementById('grid-shell');

        if (gridSize >= 12 && window.innerWidth < 600) {
          gridShell.classList.add('show-scroll');
        } else {
          gridShell.classList.remove('show-scroll');
        }

        if (gridSize >= 12) {
          document.querySelectorAll('.cell').forEach(cell => cell.classList.add('big-grid'));
        }
        if (gridSize === 12) {
          document.getElementById('grid-container').classList.add('zoom-out');
        }
  
        function createEmptyGrid() {
            for (let i = 0; i < gridSize; i++) {
                grid[i] = [];
                cellElements[i] = [];
                for (let j = 0; j < gridSize; j++) {
                grid[i][j] = '';
                cellElements[i][j] = null;
                }
            }
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function getCellData(el) {
            return {
                element: el,
                letter: el.textContent,
                row: parseInt(el.dataset.row),
                col: parseInt(el.dataset.col)
            };
        }

        function tryPlacingWords(wordList, maxWords = 12) {
            const placed = [];
            const copy = [...wordList];
            shuffle(copy);
        
            for (let originalWord of copy) {
                const cleanWord = originalWord.replace(/\s+/g, '').toUpperCase();
        
                if (cleanWord.length > gridSize) continue; // skip overly long words
                if (placed.length >= maxWords) break;
        
                if (placeWord(cleanWord)) {
                    placed.push({ display: originalWord, value: cleanWord });
                }
            }
        
            // 🌟 Add a hidden bonus word (guaranteed)!
            const allWords = wordList.filter(w => !placed.some(p => p.display === w));
            bonusWord = ''; // reset before attempting placement
        
            for (let i = 0; i < allWords.length; i++) {
                const candidate = allWords[i].replace(/\s+/g, '').toUpperCase();
                if (!placed.some(p => p.value === candidate) && placeWord(candidate)) {
                    bonusWord = candidate;
                    break;
                }
            }
        
            // 🪄 Optional backup: reuse a placed word if nothing else fits
            if (!bonusWord && placed.length > 0) {
                const fallback = placed[Math.floor(Math.random() * placed.length)];
                bonusWord = fallback.value;
            }
        
            return placed;
        }

        function generatePuzzle() {
            document.getElementById('congrats-overlay').style.display = 'none';
            document.getElementById('interaction-blocker').style.display = 'none';
            document.getElementById('grid').classList.remove('grid-disabled'); 
          
            const sizeValue = document.getElementById('size-select').value;
            const listValue = document.getElementById('wordlist-select').value;
            currentPuzzleTheme = listValue; // store the theme globally
            const wordListObj = wordLists[listValue];

            const wordList = wordListObj.words;
            const facts = wordListObj.facts;

            const randomFact = facts[Math.floor(Math.random() * facts.length)];
            document.getElementById('puzzle-fact').textContent = `${randomFact}`;

            document.getElementById('hidden-word-value').textContent = '(still hiding...)';
            if (floatingWordling) {
              floatingWordling.remove();
              floatingWordling = null;
              floatingWordlingImage = null;
            }

            gridSize = parseInt(sizeValue);

            selectedCells = [];
            selectedCells.direction = null;

            createEmptyGrid();
            const maxWords = Math.floor(gridSize * 0.8); // scale with grid size
            words = tryPlacingWords(wordList, maxWords);
            fillEmptyCells();
            renderWordList();
            renderGrid();

            console.log("Placed words:", words.map(w => w.display));
            console.log("Bonus word:", bonusWord);
        }
  
        function placeWord(word) {
            for (let attempts = 0; attempts < 100; attempts++) {
                const dir = directions[Math.floor(Math.random() * directions.length)];
                const row = Math.floor(Math.random() * gridSize);
                const col = Math.floor(Math.random() * gridSize);
        
                let fits = true;
                for (let i = 0; i < word.length; i++) {
                const r = row + dir[0] * i;
                const c = col + dir[1] * i;
                if (r < 0 || r >= gridSize || c < 0 || c >= gridSize || (grid[r][c] && grid[r][c] !== word[i])) {
                    fits = false;
                    break;
                }
                }
        
                if (fits) {
                for (let i = 0; i < word.length; i++) {
                    const r = row + dir[0] * i;
                    const c = col + dir[1] * i;
                    grid[r][c] = word[i];
                }
                return true;
                }
            }
            return false;
        }
  
        function fillEmptyCells() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                if (!grid[i][j]) {
                    grid[i][j] = letters[Math.floor(Math.random() * letters.length)];
                    }
                }
            }
        }
  
        function renderWordList() {
            const listDiv = document.getElementById('word-list');
            listDiv.innerHTML = '<strong>Find these words:</strong><br>' +
                words.map(w => `<span id="word-${w.value}">${w.display}</span>`).join(', ');
        }
  
        function renderGrid() {
            const gridDiv = document.getElementById('grid');
            gridDiv.innerHTML = '';
            gridDiv.style.gridTemplateColumns = `repeat(${gridSize}, 30px)`; // <-- this fixes it!

            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                const cell = document.createElement('div');
                cell.textContent = grid[i][j];
                cell.className = 'cell';
                cell.dataset.row = i;
                cell.dataset.col = j;

                cell.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    isMouseDown = true;
                    clearSelection();
                    selectCell(cell);
                });

                cell.addEventListener('mouseenter', () => {
                    if (isMouseDown) selectCell(cell);
                });

                cell.addEventListener('mouseup', () => {
                    isMouseDown = false;
                    checkSelectedWord();
                });

                cell.addEventListener('touchstart', handleTouchStart, { passive: false });
                cell.addEventListener('touchmove', handleTouchMove, { passive: false });
                cell.addEventListener('touchend', handleTouchEnd);

                gridDiv.appendChild(cell);
                cellElements[i][j] = cell;
                }
            }

            document.body.addEventListener('mouseup', () => {
                isMouseDown = false;
                checkSelectedWord();
            });
        }

        function handleTouchStart(e) {
          e.preventDefault();
          const target = e.target.closest('.cell');
          if (target) {
            selecting = true;
            clearSelection(); // 🔥 reset any previous selection
            selectCell(target);
          }
        }

        function handleTouchMove(e) {
          e.preventDefault();
          const touch = e.touches[0];
          const target = document.elementFromPoint(touch.clientX, touch.clientY);
          if (target && target.classList.contains('cell') && selecting) {
            selectCell(target); // 🔥 Use your core function!
          }
        }

        function handleTouchEnd(e) {
          if (selecting) {
            selecting = false;
            checkSelectedWord();
            clearSelection();
            selectedCells = [];
          }
        }
  
        function selectCell(cell) {
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            const last = selectedCells[selectedCells.length - 1];

            // Start with first cell
            if (!last) {
                cell.classList.add('selected');
                selectedCells.push({ row, col, letter: grid[row][col], element: cell });
                return;
            }

            // Undo/backtrack if dragging over previous cell
            if (
                selectedCells.length > 1 &&
                row === selectedCells[selectedCells.length - 2].row &&
                col === selectedCells[selectedCells.length - 2].col
            ) {
                last.element.classList.remove('selected');
                selectedCells.pop();
                return;
            }

            // Already selected elsewhere: ignore
            if (selectedCells.some(c => c.row === row && c.col === col)) return;

            // Lock direction from first two cells
            if (selectedCells.length === 1) {
                const dRow = row - last.row;
                const dCol = col - last.col;
                if ((dRow === 0 && dCol === 0) || Math.abs(dRow) > 1 || Math.abs(dCol) > 1) return;

                selectedCells.direction = [dRow, dCol];
            } else if (selectedCells.direction) {
                // Allow small error margin for direction
                const expectedRow = last.row + selectedCells.direction[0];
                const expectedCol = last.col + selectedCells.direction[1];

                const rowDiff = Math.abs(expectedRow - row);
                const colDiff = Math.abs(expectedCol - col);

                if (rowDiff > 0.2 || colDiff > 0.2) return; // allow slight error
            }

            // Save the original background color so we can restore it
            const previousColor = cell.style.backgroundColor;
            
            cell.classList.add('selected');
            cell.dataset.prevColor = previousColor || ''; // store inline color if any
            cell.style.backgroundColor = ''; // let CSS handle the selected style
            selectedCells.push({ row, col, letter: grid[row][col], element: cell });
        }
        
        function clearSelection() {
            selectedCells.forEach(cell => {
              cell.element.classList.remove('selected');
              if (cell.element.dataset.prevColor) {
                cell.element.style.backgroundColor = cell.element.dataset.prevColor;
                delete cell.element.dataset.prevColor;
              }
            });
            selectedCells = [];
            selectedCells.direction = null; // Reset direction
        }

        function getRandomPastel() {
            const hue = Math.floor(Math.random() * 360);
            return `hsl(${hue}, 70%, 85%)`; // pastel-like
        }

        function createImageWordling(size = 48, theme = 'fruits', returnImageOnly = true) {
            const army = wordlingThemes[theme] || ['wordling1.png'];
            const chosen = army[Math.floor(Math.random() * army.length)];
        
            const img = document.createElement('img');
            img.src = `images/${chosen}`;
            img.alt = 'Wordling';
            img.className = 'wordling-img';
            img.style.width = `${size}px`;
        
            return returnImageOnly ? img : { img, chosen };
        }

        function showWordlingPop(imageFile) {
          // Remove any existing pop-up
          const old = document.getElementById('label-wordling');
          if (old) old.remove();
        
          const label = document.getElementById('hidden-word-value');
          const wordling = document.createElement('img');
          wordling.src = `images/${imageFile}`;
          wordling.classList.add('wordling-pop');
          wordling.id = 'label-wordling';
        
          const labelBox = label.getBoundingClientRect();
        
          // 🛠️ Define the offsets before using them
          const offsetX = labelBox.left + window.scrollX + labelBox.width + 10;
          const offsetY = labelBox.top + window.scrollY - 10;
        
          wordling.style.left = `${offsetX}px`;
          wordling.style.top = `${offsetY}px`;
        
          document.body.appendChild(wordling);
        
          // Track it
          floatingWordling = wordling;
          floatingWordlingImage = imageFile;
        
          // 🎉 Confetti!
          confetti({
            particleCount: 30,
            spread: 60,
            startVelocity: 25,
            origin: {
              x: offsetX / window.innerWidth,
              y: offsetY / window.innerHeight
            }
          });
        }

        function unlockCosplayWordling() {
          const emptyMsg = document.getElementById('cosplay-empty');
          if (emptyMsg) emptyMsg.style.display = 'none';
          
          const available = cosplayWordlings.filter(w => !unlockedCosplays.includes(w));
          if (available.length === 0) return; // all unlocked
        
          const chosen = available[Math.floor(Math.random() * available.length)];
          unlockedCosplays.push(chosen);
        
          const cosplayImg = document.createElement('img');
          cosplayImg.src = `images/${chosen}`;
          cosplayImg.alt = 'Cosplay Wordling';
          cosplayImg.className = 'wordling-img';
          cosplayImg.style.height = '64px';
          cosplayImg.style.margin = '4px';
        
          document.getElementById('cosplay-section').appendChild(cosplayImg);
        
          // Optional: Add message pop-up
          //alert('🎉 You unlocked a Cosplay Wordling!');
        }

        function showKorok() {
            const existingPop = document.getElementById('label-wordling');
            if (existingPop) existingPop.remove();
        
            if (bonusWord) {
                document.getElementById('hidden-word-value').textContent = bonusWord;
            }
        
            const { chosen } = createImageWordling(48, currentPuzzleTheme, false);
            showWordlingPop(chosen); // just shows it — we’ll move it later
        }
  
        function checkSelectedWord() {
            if (selectedCells.length === 0) return;
            const word = selectedCells.map(c => c.letter).join('');
            const reversed = word.split('').reverse().join('');

            const match = words.find(w => w.value === word || w.value === reversed);
            const isBonus = word === bonusWord || reversed === bonusWord;

            if (match || isBonus) {
                const pastel = getRandomPastel();
                selectedCells.forEach(c => {
                    c.element.style.backgroundColor = pastel;
                    c.element.classList.add('found');
                });

                if (match) {
                    document.getElementById(`word-${match.value}`).classList.add('found-word');
                }

                if (isBonus) {
                    showKorok();
                }

                checkIfPuzzleComplete();
            }

            clearSelection();
        }

        function moveLabelWordlingToRow() {
          const emptyMsg = document.getElementById('army-empty');
          if (emptyMsg) emptyMsg.style.display = 'none';
          
          if (!floatingWordling || !floatingWordlingImage) return;
        
          // Clean up the label Wordling
          floatingWordling.removeAttribute('id');
          floatingWordling.classList.remove('wordling-pop');
          floatingWordling.classList.add('wordling-row-img');
          floatingWordling.removeAttribute('style');
        
          const row = document.getElementById('wordling-row');
        
          row.appendChild(floatingWordling);

            // ✅ Increment the count ONLY when Wordling actually joins
          korokCount++;
          document.getElementById('korok-count').textContent = korokCount;
        
          // ✅ Check for cosplay unlocks too
          if (korokCount % 5 === 0) {
            unlockCosplayWordling();
          }
        
          // Clear the reference after moving
          floatingWordling = null;
          floatingWordlingImage = null;
        }
        

        function checkIfPuzzleComplete() {
            const found = document.querySelectorAll('.found-word').length;
            if (found === words.length) {
                document.getElementById('congrats-overlay').style.display = 'flex';
                launchConfetti(); // 🎉 Right here!
                moveLabelWordlingToRow(); // 🌟 move the Wordling to the row
                document.getElementById('grid').classList.add('grid-disabled');
                document.getElementById('interaction-blocker').style.display = 'block';
            }
        }

        function launchConfetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { x: 0.5, y: 0.5 }
            });
        }
  
        // Run the game
        document.getElementById('new-game-btn').addEventListener('click', generatePuzzle);
        generatePuzzle(); // initial load
    
    </script>
</body>
</html>
