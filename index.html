<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Coming+Soon&display=swap" rel="stylesheet">

  <link rel="preload" as="image" href="images/wordling-title.png">
  <link rel="prefetch" as="image" href="images/wordling1.png">
  <link rel="prefetch" as="image" href="images/wordling2.png">
  <link rel="prefetch" as="image" href="images/wordling3.png">
  <link rel="prefetch" as="image" href="images/wordling4.png">
  <link rel="prefetch" as="image" href="images/cozy-wordling1.png">
  <link rel="prefetch" as="image" href="images/cozy-wordling2.png">
  <link rel="prefetch" as="image" href="images/gem-wordling1.png">
  <link rel="prefetch" as="image" href="images/gem-wordling2.png">
  <link rel="prefetch" as="image" href="images/gem-wordling3.png">
  <link rel="prefetch" as="image" href="images/gem-wordling4.png">
  <link rel="prefetch" as="image" href="images/miku-wordling1.png">
  <link rel="prefetch" as="image" href="images/miku-wordling2.png">
  <link rel="prefetch" as="image" href="images/miku-wordling3.png">
  <link rel="prefetch" as="image" href="images/cloudling.png">
  <link rel="prefetch" as="image" href="images/ceciling.png">
  <link rel="prefetch" as="image" href="images/dekuling.png">
  <link rel="prefetch" as="image" href="images/gokuling.png">
  <link rel="prefetch" as="image" href="images/moonling.png">
  <link rel="prefetch" as="image" href="images/pokeling.png">
  <link rel="prefetch" as="image" href="images/squalling.png">
  <link rel="prefetch" as="image" href="images/terraling.png">
  <link rel="prefetch" as="image" href="images/warrioroflightling.png">
  <link rel="prefetch" as="image" href="images/zidaneling.png">
  <link rel="prefetch" as="image" href="images/igneous-wordling.png">
  <link rel="prefetch" as="image" href="images/sedimentary-wordling.png">
  <link rel="prefetch" as="image" href="images/metamorphic-wordling.png">
  
  <title>Wordsearch Puzzle</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }

    #grid {
      display: grid;
      grid-gap: 2px;
      justify-content: center;
      margin: 20px 0;
    }

    .cell {
      width: 30px;
      height: 30px;
      background-color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
      user-select: none;
    }

    .selected {
      background-color: #fff5b1;
      box-shadow: inset 0 0 4px #f4d06f;
    }

    .found {
      background-color: #90ee90;
    }

    #word-list {
      margin-bottom: 10px;
    }

    .found-word {
      text-decoration: line-through;
      color: gray;
    }

    #wordsearch-app {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        border: 4px solid #ccc;
        border-radius: 16px;
        background-color: #fafafa;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    #controls {
        margin-bottom: 10px;
    }

    #grid-shell {
      display: flex;
      justify-content: center;
      overflow-x: auto;
      padding: 8px;
      max-width: 100vw;
    }
    
    #grid-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 8px;
      flex-wrap: wrap;
      position: relative;
    }

    #game-title img {
      height: 200px;
      width: auto;
      display: block;
      margin: 0 auto;
    }

    #puzzle-fact {
      margin-top: 20px;
      padding: 14px 16px;
      border-radius: 12px;
      background: linear-gradient(to bottom right, #fffdf6, #fdf6e3);
      color: #5e4a32;
      font-family: 'Coming Soon', cursive;
      font-size: 1.05em;
      font-style: italic;
      line-height: 1.5;
      border: 2px dotted #dbc196;
      box-shadow: 0 2px 6px rgba(180, 160, 100, 0.1);
      position: relative;
      transition: transform 0.2s ease;
    }

    #congrats-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 1em;
        font-weight: bold;
        color: #4b0082;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
        z-index: 10;
        pointer-events: none;
        text-align: center;
        white-space: nowrap;         /* üí• Force single line */
        max-width: none;             /* üí• Don‚Äôt cap the width */
    }

    #interaction-blocker {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: 2;
      display: none;
    }

    .grid-disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    @keyframes pop {
        0% { transform: scale(0.6); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    #wordsearch-app h1 {
        font-family: 'Segoe UI', 'Quicksand', 'Comic Neue', sans-serif;
        font-size: 2.5em;
        font-weight: 700;
        color: #ab84d8; /* soft purple */
        text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.6);
        margin-bottom: 20px;
        text-align: center;
    }

    @keyframes shine {
        0% { background-position: 0% }
        100% { background-position: 100% }
    }

    #wordling-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .header-wordling {
      width: 48px;
      height: auto;
    }

    #wordling-row {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .wordling-row-img {
        width: 48px;
        height: 48px;
        object-fit: contain;
        display: inline-block;
        animation: pop-in 0.4s ease;
        user-select: none;
    }

    #cosplay-section {
      margin-top: 20px;
      text-align: center;
      background: #f7f7ff;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(180, 180, 255, 0.2);
    }
    
    #cosplay-wordling-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      padding-top: 10px;
    }

    #hidden-word {
        text-align: center;
        color: #444;
        font-size: 1em;
    }

    .hint-text {
      font-family: 'Coming Soon', cursive;
      font-size: 0.9em;
      color: #5c4033;
      text-align: center;
      margin-bottom: 8px;
      opacity: 0.8;
    }

    @keyframes sparkle {
      0% {
        transform: scale(1);
        text-shadow: none;
      }
      25% {
        transform: scale(1.1);
        text-shadow: 0 0 6px #fff8dc, 0 0 10px #b3f4d6;
      }
      50% {
        transform: scale(1);
        text-shadow: none;
      }
      75% {
        transform: scale(1.05);
        text-shadow: 0 0 4px #fff8dc;
      }
      100% {
        transform: scale(1);
        text-shadow: none;
      }
    }
    
    .sparkle {
      animation: sparkle 0.8s ease-in-out;
    }

    .wordling-pop {
      position: absolute;
      width: 40px;
      height: auto;
      animation: wordling-pop 1.2s ease-out;
      z-index: 20;
      pointer-events: none;
    }
    
    @keyframes wordling-pop {
      0%   { transform: scale(0.2); opacity: 0; }
      40%  { transform: scale(1.2); opacity: 1; }
      80%  { transform: scale(1); }
      100% { opacity: 0; transform: scale(0.9); }
    }

    @media (max-width: 600px) {
      #grid {
        font-size: 1em;;
        gap: 4px;
        margin: 0 auto;
      }

      #grid-shell {
        display: flex;
        justify-content: flex-start;
        overflow-x: hidden;
        padding: 8px;
        width: 100%;
        max-width: 100vw;
        scrollbar-width: thin;
        scrollbar-color: #b5e0ca #f3f3f3; /* pastel green on soft background */
        box-sizing: border-box;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
      }

      #grid-shell::-webkit-scrollbar {
        height: 8px;
      }
    
      #grid-shell::-webkit-scrollbar-track {
        background: #f3f3f3;
        border-radius: 4px;
      }
    
      #grid-shell::-webkit-scrollbar-thumb {
        background-color: #b5e0ca;
        border-radius: 4px;
      }
    
      #grid-shell::-webkit-scrollbar-thumb:hover {
        background-color: #94cfb4;
      }

      #grid-shell::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        width: 16px;
        background: linear-gradient(to right, transparent, rgba(0,0,0,0.05));
        pointer-events: none;
      }
      
      #grid-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 8px;
        flex-wrap: wrap;
      }
      
      .cell {
        width: 26px;
        height: 26px;
      }
      
      select,
      button {
        font-size: 1.2em;
        padding: 10px 16px;
        border-radius: 8px;
      }
      
      #wordlist-select, #size-select {
        width: 100%;
        margin-bottom: 10px;
      }
      
      #wordling-row {
        overflow-x: auto;
        white-space: nowrap;
        justify-content: flex-start;
        padding: 10px 6px;
        scroll-snap-type: x mandatory;
      }
      
      .wordling-row-img {
        scroll-snap-align: center;
      }
      
      #grid-container.zoom-out {
        transform: scale(0.95);
      }
    
      .cell {
        width: 26px;
        height: 26px;
      }
    
      /* For large grids, squeeze more */
      .cell.big-grid {
        width: 22px;
        height: 22px;
      }

    }
  </style>

</head>

<body>
    <div id="wordsearch-app">
        <div id="wordling-header">
          <div id="game-title">
            <img src="images/wordling-title.png" alt="Wordling Search Logo" />
          </div>
        </div>
    
        <div id="controls">
            <label for="size-select">Grid Size:</label>
            <select id="size-select">
                <option value="8">8√ó8</option>
                <option value="10" selected>10√ó10</option>
                <option value="12">12√ó12</option>
            </select>
    
            <label for="wordlist-select" style="margin-left: 10px;">Word List:</label>
            <select id="wordlist-select">
                <optgroup label="üêæ Animals">
                  <option value="domesticAnimals">üê∞ Domestic Animals</option>
                <optgroup label="üçé Food">
                  <option value="fruits">üçì Fruits</option>
                <optgroup label="üåç Geology">
                  <option value="gemstones">üíé Gemstones</option>
                  <option value="igneousRocks">üåã Igneous Rocks</option>
                  <option value="metamorphicRocks">ü™® Metamorphic Rocks</option>
                  <option value="sedimentaryRocks">‚åõ Sedimentary Rocks</option>
                <optgroup label="üéµ Music">
                  <option value="miku">üåü Hatsune Miku</option>
                  <option value="mikusongs">üé§ Hatsune Miku Songs</option>
                <optgroup label="üìú Other">
                  <option value="cozy">üî• Cozy Words</option>
            </select>
    
            <button id="new-game-btn" style="margin-left: 10px;">New Puzzle</button>
        </div>
    
        <div id="word-list"></div>
        <div id="hidden-word" style="margin-top: 10px; font-style: italic;">
            <strong>Hidden Word:</strong> <span id="hidden-word-value">(still hiding...)</span>
        </div>

        <div id="grid-shell">
          <div id="grid-container" style="position: relative; display: inline-block;">
              <div id="grid"></div>
              <div id="congrats-overlay" style="display: none;">
                  üåü Puzzle Complete! üåü
              </div>
              <div id="interaction-blocker"></div>
          </div>
        </div>
        
        <div id="puzzle-fact"></div>

        <div id="wordling-row" style="margin-top: 20px;">
          <p id="army-empty" class="hint-text">You haven't found any wordlings yet...</p>
        </div>
        <div id="cosplay-section">
          <h3>üåü Cosplay Wordlings</h3>
          <div id="cosplay-wordling-row">
            <p id="cosplay-empty" class="hint-text">Find 5 wordlings to unlock!</p>
          </div>
        </div>
        <div id="korok-stats" style="margin-top: 10px; font-size: 0.9em; color: #4b0082;">
            üåø Wordlings found: <span id="korok-count">0</span>
        </div>
    </div>
  
    

    <script>
        const wordLists = {
            fruits: {
                words: ['APPLE', 'BANANA', 'ORANGE', 'KIWI', 'MANGO', 'GRAPE', 'PEAR', 'MELON', 'CHERRY', 'LEMON', 'APRICOT', 'AVOCADO', 'BLACKBERRY', 'BLUEBERRY', 'BOYSENBERRY', 'CITRON', 'COCONUT', 'CRANBERRY', 'CURRANT', 'DATE', 'DRAGONFRUIT', 'DURIAN', 'ELDERBERRY', 'FIG', 'LIME', 'GOOSEBERRY', 'GRAPEFRUIT', 'GUAVA', 'JACKFRUIT', 'PLUM', 'KUMQUAT', 'LYCHEE', 'CANTALOUPE', 'HONEYDEW', 'WATERMELON', 'NECTARINE', 'CLEMENTINE', 'TANGERINE', 'PAPAYA', 'PASSIONFRUIT', 'PEACH', 'PERSIMMON', 'PINEAPPLE', 'POMEGRANATE', 'POMELO', 'QUINCE', 'RASPBERRY', 'STRAWBERRY', 'YUZU'],
                facts: [
                  "üçå Harvest Wordlings giggle that bananas are berries‚Ä¶ but strawberries are just pretending!",
                  "üçä Oranges were once so rare in Europe, they were given like treasure during winter festivals.",
                  "üçé Apples are 25% air‚Äîno wonder they float in cider streams and orchard ponds.",
                  "ü•ù Kiwi was once called the ‚ÄòChinese gooseberry‚Äô‚Äîbut it got a cuter name in New Zealand!",
                  "üçá Grapes explode in the microwave‚Ä¶ and the Wordlings kindly ask you not to test this.",
                  "üåπ Cherries bloom with the roses and carry the same perfume in their spring breeze.",
                  "üçê Old pear trees have watched over generations‚Äîthey can live for more than a hundred years!",
                  "üçã In the misty orchards of East Asia, yuzus glow like lemons, but their taste is a whisper of floral lime and morning breeze.",
                  "üçì Raspberries are made of many tiny pieces, each holding hands to form the whole ‚Äî like a fruit that grew from a gathering.",
                  "üçê A quince is stubborn and sour until softened by time or fire ‚Äî a fruit that must be earned, not taken.",
                  "üçä Pomelos are the gentle giants of the citrus grove, nearly ten inches wide and heavy with mellow sweetness.",
                  "üå∫ In Armenian stories, pomegranates hold seeds of life, luck, and love ‚Äî one fruit, many blessings.",
                  "üå∏ Some plum trees cannot bloom alone. Without a nearby friend, their flowers go unanswered and bear no fruit.",
                  "üçç Pineapples got their name from explorers who saw pinecones and tasted paradise ‚Äî and the name stuck like sunlight on skin.",
                  "üçë Take the fuzz off a peach and you‚Äôre left with a nectarine ‚Äî just as sweet, just a little smoother.",
                  "üå∂Ô∏è The seeds of a papaya carry a peppery surprise, sharp enough to stand in for black peppercorns at any table.",
                  "üçâ In parts of Japan, watermelons are grown in shapes: hearts for romance, squares for shelves ‚Äî a fruit made whimsical.",
                  "üç¨ Lychee seeds must be left behind; though the fruit is soft and fragrant, the seed carries danger at its core.",
                  "üåû A guava holds five times the sunshine of an orange ‚Äî bursting with brightness in every bite.",
                  "‚ö†Ô∏è Grapefruits carry warnings. Their juice can twist the power of medicine, so potions and fruit must be chosen wisely.",
                  "üå∞ A fig‚Äôs flower lives inside the fruit ‚Äî hidden, secret, only seen when the fig is opened like a little lantern.",
                  "üö´ The durian‚Äôs smell is so strong that hotels and trains ask it to stay outside, no matter how sweet its heart may be.",
                  "üå¥ Date trees wear long feather-like fronds and stretch toward desert skies, dreaming of oasis winds.",
                  "üêâ Dragonfruit earned its name from armor and scales ‚Äî leathery skin and spikes like something from a myth.",
                  "ü•• Coconuts are patient voyagers. They float across oceans for up to 110 days, looking for soft sand and new beginnings.",
                  "üçí Cranberries are called superfruits ‚Äî not for flying, but for brimming with little strengths: vitamins, color, and courage."
                ]
            },
            domesticAnimals: {
                words: ['ALPACA', 'CAMEL', 'CHICKEN', 'DONKEY', 'GOAT', 'MINK', 'CATTLE', 'CAT', 'DOG', 'FERRET', 'HORSE', 'PIG', 'RABBIT', 'WATER BUFFALO', 'SILVER FOX', 'SHEEP', 'YAK', 'MOUSE', 'RAT', 'HEDGEHOG', 'LLAMA', 'DOVE', 'CANARY', 'COCKATIEL', 'DUCK', 'GOOSE', 'PIGEON', 'TURKEY', 'GUINEAFOWL', 'HONEY BEE', 'SILKMOTH', 'GOLDFISH', 'KOI', 'GUINEA PIG'],
                facts: [
                  "üêï Dogs were the first to walk beside us ‚Äî a friendship older than any written word.",
                  "üçû After so many meals together, dogs can thrive on bread and stew, unlike their wild cousins.",
                  "üêè Once, all sheep wore earth tones, but we taught them to grow fleeces white as snow or dark as twilight.",
                  "üêñ Pigs cannot sweat, so they cool off in puddles and shade ‚Äî clever comfort-seekers.",
                  "üêÑ The cow‚Äôs story is written deep in its genes ‚Äî one of the first to have a fully-mapped genome.",
                  "üêà A cat‚Äôs front limbs are bound by floating bones, letting them slip through any place their whiskers fit.",
                  "üßÄ Neolithic farmers kept goats for milk and meat, and their bell calls still echo through the hills.",
                  "ü•ö A hardworking hen can give over 300 eggs in a single turning of the seasons.",
                  "üê¥ Ten donkeys were once buried with a pharaoh, as if honored like noble humans.",
                  "ü¶Ü Ducklings don‚Äôt make their own waterproofing ‚Äî they borrow their mother‚Äôs oil for their fluffy adventures.",
                  "üê´ Dromedary camels can survive losing more than 30% of their water ‚Äî and keep walking.",
                  "üêù Honeybees dance and scent the air with messages only other bees can read.",
                  "üêé Horses nap standing or curled on the ground, choosing comfort or watchfulness as needed.",
                  "üï∏Ô∏è Sericulture is the gentle craft of raising silkworms for threads softer than breath.",
                  "üïäÔ∏è Pigeons have lived with humans since Mesopotamia, over five thousand years ago.",
                  "ü™ø During a quiet pandemic patrol, geese once stood watch at a border with Vietnam ‚Äî wings flared like guards.",
                  "üêÇ Yaks don‚Äôt moo ‚Äî they grunk and squeak, like old boots and hidden horns.",
                  "ü¶ô Llamas bring calm to those in pain, quietly visiting hospitals as certified therapy animals.",
                  "üêë Alpacas are separated not by sound or stride, but by their wool ‚Äî some curly, some straight.",
                  "üçó Guineafowl can stand in for chicken in a stew, and some say they bring even more flavor.",
                  "üéØ Ferrets were once sport companions, hunting rabbits through tunnels in a tradition called rabbiting.",
                  "üé© White doves flutter through magic acts and ceremonies, bringing softness and illusion together.",
                  "üêü Goldfish released into the wild grow bold and large ‚Äî so much that they become invaders.",
                  "üêá Rabbits hopped into human lives when the Romans first invited them indoors.",
                  "üéè Koi are the bright-painted variant of humble carp, swimming not for food but for beauty.",
                  "üêÅ A ‚Äòfancy mouse‚Äô is one bred for show ‚Äî tiny, whiskered, and well-groomed for pageantry.",
                  "ü¶¶ Some still debate whether domestic mink are truly tamed, or only wearing the mask of calm.",
                  "ü¶ä Silver foxes were born from experiments that asked how wild things become our companions.",
                  "ü¶î In ancient Greece, hedgehogs were welcomed inside homes to eat the insects no one else wanted."
                ]
            },
            cozy: {
                words: ['TEA', 'BLANKET', 'FIREPLACE', 'BOOK', 'CANDLE', 'WINDOW', 'SOCKS', 'COCOA', 'QUILT', 'SLIPPERS'],
                facts: [
                  "üïØÔ∏è Hearthlings remember when candles were made from beeswax or fat‚Äîevery flicker hard-earned.",
                  "üìñ Reading by firelight was once a winter treasure, saved for the longest nights.",
                  "üßµ The oldest known quilt comes from 3400 BC‚ÄîHearthlings say it still dreams in patterns.",
                  "üë£ Slippers were invented in ancient China to make footsteps soft and silent indoors.",
                  "üçµ In the 1800s, tea was so precious it came with a key‚Äîlocked in its own tiny chest.",
                  "üß¶ Wool socks are naturally cozy *and* fight off foot-odor gremlins ‚Äî Hearthling tested."
                ]
            },
            gemstones: {
                words: ['AGATE', 'ALEXANDRITE', 'AMBER', 'AMETHYST', 'APATITE', 'BERYL', 'CHALCEDONY', 'CITRINE', 'CORUNDUM', 'DIAMOND', 'EMERALD', 'GARNET', 'ONYX', 'OPAL', 'PEARL', 'PERIDOT', 'QUARTZ', 'ROSE QUARTZ', 'RUBY', 'SAPPHIRE', 'TOPAZ', 'TOURMALINE', 'TURQUOISE', 'ZIRCON'],
                facts: [
                  "üíé Gemlings say only four stones are called truly precious: diamond, ruby, sapphire, and emerald.",
                  "üåø Amber isn't a stone at all‚Äîit's the ancient memory of trees, hardened into golden glass.",
                  "üß° Some say you can find tiny creatures or petals frozen in amber‚Äôs golden embrace.",
                  "üíú Amethyst's violet glow comes from whispers of iron and sunlight trapped deep inside.",
                  "ü¶∑ Wordlings whisper that Apatite is what teeth dream of becoming.",
                  "üí† Diamond is the hardest truth the earth can speak.",
                  "üî∑ Though diamonds begin pure, a single impurity can turn them blue, brown, or rainbow-touched.",
                  "üîÆ Garnets come in every color‚Äîbut blue ones are so rare that even Gemlings blink twice.",
                  "üíö A tsavorite garnet may not be 'precious,' but it shines with the price of royalty.",
                  "üíß Opals are soft water trapped in stone‚Äîsometimes as much as a fifth of their weight!",
                  "üåà Opals don't follow crystal rules‚Äîthey're pure rainbow chaos.",
                  "ü¶™ Pearls are made by sea-mollusks when they turn irritation into treasure.",
                  "üåø Peridot is what olivine becomes when it gets dressed up for a ball.",
                  "üçè Peridot glows green thanks to iron hiding in its heart.",
                  "üé® Quartz wears many colors‚Äîwhen it's purple, we call it amethyst; when golden, citrine.",
                  "ü™® Pure quartz is clear as truth‚Äîsome call it rock crystal.",
                  "üî• Both ruby and sapphire are born from the same mineral, corundum‚Äîjust dressed in different flames."
                ]
            },
            miku: {
              words: ['HATSUNE MIKU', 'VOCALOID', 'CRYPTON', 'TWINTAILS', 'VIRTUAL', 'IDOL', 'HOLOGRAM', 'SINGER', 'FIRST SOUND', 'FUTURE', 'SAKI FUJITA', 'KEI GARO', 'YAMAHA', 'PHONIC', 'VOICEBANK', 'DANCE', 'SPRING ONION', 'LEEK', 'PROJECT DIVA', 'CHARACTER', 'TURQUOISE', 'ANDROID', 'COMPUTER', 'JAPANESE', 'SYNTHESIZER', 'RHYTHM'],
              facts: [
                "üé§ Idol Wordlings say Miku was the very first voice in a new digital songbook‚ÄîCV-01, the start of it all.",
                "üåü Sometimes, you can catch her performing live in light and holograms, like a dream on stage.",
                "üéôÔ∏è Her voice was woven from Saki Fujita‚Äôs, like sunlight filtered through a synthesizer.",
                "üí´ 'Hatsune Miku' means 'The First Sound of the Future'‚Äîa whisper from tomorrow itself.",
                "üé® Wordlings say her turquoise glow was chosen before anything else‚Äîjust the color, and a dream of music.",
                "üéπ Her shade of turquoise matches the tones of Yamaha‚Äôs magical music machines.",
                "üß§ The glowing sleeve on her arm? It holds echoes of synthesizer lights from long ago.",
                "üó£Ô∏è Miku doesn‚Äôt speak like us‚Äîshe sings in syllables, phonics stitched into melody.",
                "üìÖ Pop Idol Wordlings celebrate her birthday on August 31st, when the songs began again.",
                "ü§ñ Miku was imagined as a future diva in a world where songs had vanished‚Äîbut she brought them back.",
                "üåç She was the first to bring her voice across oceans with Vocaloid 3‚Äôs English library.",
                "üéß At first, she wasn‚Äôt meant for fans at all‚Äîjust for pros. But the world had other plans.",
                "üßÖ Thanks to one silly video, Miku‚Äôs now forever dancing with spring onions and leeks.",
                "üéÆ Sega Wordlings built her a stage in rhythm‚Äîan entire world of beats called Project Diva."
              ]
            },
            mikusongs: {
              words: ['ABSOLUNOTE', 'ACUTE', 'AGEAGE AGAIN', 'AIKOTOBA', 'ALIEN ALIEN', 'BLACK ROCK SHOOTER', 'CANTARELLA', 'CAT FOOD', 'CATCH THE WAVE', 'CENDRILLON', 'DANCE OF MANY', 'DEAR', 'DECORATOR', 'DEEP SEA GIRL', 'DREAMING LEAF', 'DENPARADIGM', 'DRAMATURGY', 'DOUBLEGANGER', 'ELECTRIC ANGEL', 'ENVY CAT WALK', 'FINDER', 'FROM Y TO Y', 'GHOST RULE', 'GIGANTIC GIRL', 'GIZMO', 'HAND IN HAND', 'HIBIKASE', 'HIBANA', 'HIGH SCHOOL DAYS', 'HOLY STAR', 'INNOCENCE', 'INTERVIEWER', 'JITTERBUG', 'KIMI NI', 'KNIFE', 'KNIGHT OF LIGHT', 'LOVE IS WAR', 'LUCID DREAMING', 'MAGNET', 'MARGINAL', 'MASTER OF PUPPETS', 'METEOR', 'MIRACLE PAINT', 'MOON', 'MOUSOU SKETCH', 'NEKOMIMI SWITCH', 'PINK MOON', 'PINKY SWEAR', 'PO PI PO', 'PROMISE', 'PUZZLE', 'ROLLING GIRL', 'ROMEO AND CINDERELLA', 'SAIHATE', 'SAKURA NO AME', 'SECRET POLICE', 'SENBONZAKURA', 'SOUND', 'SLUMP', 'STAR STORY', 'STARDUSTER', 'STARGAZER', 'STEP FORWARD', 'SUMMER IDOL', 'SWEET DEVIL', 'SYSTEMATIC LOVE', 'TELL YOUR WORLD', 'THE FIRST SOUND', 'THE SECRET GARDEN', 'THE WORLD IS MINE', 'TIME LIMIT', 'TIME MACHINE', 'TORINOKOCITY', 'TRICOLORE AIRLINE', 'UNHAPPY REFRAIN', 'VELVET ARABESQUE', 'WEEKENDER GIRL', 'WOLF GIRL', 'YELLOW', 'YUMEYUME'],
              facts: [
                "üé§ Idol Wordlings say Miku was the very first voice in a new digital songbook ‚Äî CV-01, the start of it all.",
                "üåü Sometimes, you can catch her performing live in light and holograms, like a dream on stage.",
                "üéôÔ∏è Her voice was woven from Saki Fujita‚Äôs, like sunlight filtered through a synthesizer.",
                "üí´ 'Hatsune Miku' means 'The First Sound of the Future' ‚Äî a whisper from tomorrow itself.",
                "üé® Wordlings say her turquoise glow was chosen before anything else ‚Äî just the color, and a dream of music.",
                "üéπ Miku's shade of turquoise matches the tones of Yamaha‚Äôs magical music machines.",
                "üß§ The glowing sleeve on Miku's arm? It holds echoes of synthesizer lights from long ago.",
                "üó£Ô∏è Miku doesn‚Äôt speak like us‚Äîshe sings in syllables, phonics stitched into melody.",
                "üìÖ Pop Idol Wordlings celebrate Miku's birthday on August 31st, when the songs began again.",
                "ü§ñ Miku was imagined as a future diva in a world where songs had vanished ‚Äî but she brought them back.",
                "üåç Miku was the first to bring her voice across oceans with Vocaloid 3‚Äôs English library.",
                "üéß At first, she wasn‚Äôt meant for fans at all ‚Äî just for pros. But the world had other plans.",
                "üßÖ Thanks to one silly video, Miku‚Äôs now forever dancing with spring onions and leeks.",
                "üéÆ Sega Wordlings built her a stage in rhythm ‚Äî an entire world of beats called Project Diva."
              ]
            },
            igneousRocks: {
              words: ['IGNEOUS', 'MOLTEN', 'INTRUSIVE', 'CRYSTALLIZE', 'EXTRUSIVE', 'ERUPT', 'AMORPHOUS', 'BASALT', 'DIORITE', 'TRAP ROCK', 'GABBRO', 'GRANITE', 'OBSIDIAN', 'PERIDOTITE', 'PUMICE', 'RHYOLITE', 'FIRE OPAL', 'UNAKITE', 'WELDED TUFF', 'VOLCANO', 'SCORIA', 'PEGMATITE', 'MAGMA', 'DOLERITE', 'DIABASE', 'DACITE', 'INTRUSION', 'GLASS', 'PLUTONIC', 'HYPABYSSAL', 'COUNTRY ROCK', 'BATHOLITH', 'STOCK', 'LACCOLITH', 'SILL', 'DIKE', 'PHANERITIC', 'APHANITIC', 'PORPHYRY'],
              facts: [
                  "üåã Igneous rocks are born from fire ‚Äî they form when molten magma cools and stills into stone.",
                  "üîÆ Some igneous rocks form deep beneath the surface, cooling slowly to grow crystals large enough to hold in your hand.",
                  "‚ú® Some igneous rocks erupt onto the land, cooling quickly in the open air and setting their stories in tiny crystal grains.",
                  "ü™û When lava cools too fast to crystalize, it turns into volcanic glass ‚Äî smooth, dark, and mirror-like.",
                  "üöß 'Trap rock' is a builder‚Äôs name for dark igneous stones used to make roads and sturdy paths.",
                  "üåç About 15% of the Earth‚Äôs land is built from igneous stone ‚Äî quiet reminders of once-molten origins.",
                  "üî¶ Some of these rocks hide riches: veins of tin, tungsten, and other treasured minerals.",
                  "üß± Most igneous rocks are born deep in the Earth as intrusions ‚Äî hidden until the land rises or wears away.",
                  "üóª These intrusions press into the Earth‚Äôs crust, wrapped in older rock like secrets waiting to be uncovered.",
                  "üèîÔ∏è The hearts of great mountain ranges are often made of ancient intrusive stone, weathered but enduring.",
                  "üåë When formed deep and long ago, they‚Äôre called plutonic ‚Äî named for the god of the underworld.",
                  "üñ§ More than 90% of all volcanic rock is basalt ‚Äî black and ancient, like cooled midnight.",
                  "ü™® Some basalt cools into long, neat columns ‚Äî like stone honeycombs in places like Giant‚Äôs Causeway.",
                  "üî• Magma rises through the Earth because it‚Äôs lighter than the rock around it ‚Äî like a bubble seeking sky.",
                  "üîç In some fine-grained rocks, the crystals are so small they must be studied under a microscope to be known.",
                  "ü™µ The rock that surrounds an intrusion is called country rock ‚Äî it keeps the heat in so magma cools slowly.",
                  "üìè A vast intrusion is called a batholith if it‚Äôs enormous, or a stock if it‚Äôs merely large.",
                  "üèîÔ∏è A laccolith forms a stone dome beneath the surface, fed by a narrow crack called a dike.",
                  "üìö A sill slides in flat between layers of older stone ‚Äî like a secret page tucked into a book.",
                  "üåò Hypabyssal rocks form near the surface, fine-grained and quick to settle into solidness.",
                  "üîé If the crystals are large enough to see without aid, the texture is called phaneritic. If not, it‚Äôs aphantic ‚Äî hidden from plain sight.",
                  "ü™Ñ When large crystals appear in a finer background, the result is a porphyry ‚Äî like gemstones in velvet.",
                  "‚öñÔ∏è Igneous rocks are named by their chemistry ‚Äî how much silica they hold shapes their destiny.",
                  "ü™ê Basalt isn‚Äôt just found on Earth ‚Äî it paves the plains of Venus and darkens the stones of Mars.",
                  "üß± Granite is strong, massive, and unyielding ‚Äî perfect for walls, counters, and ancient monuments.",
                  "üñ§ Obsidian breaks into razor edges, sharp and beautiful ‚Äî once used to make tools, blades, and quiet weapons.",
                  "‚ùÑÔ∏è Snowflake obsidian forms when tiny white crystals of cristobalite bloom inside volcanic glass ‚Äî frozen petals in midnight stone.",
                  "üå¨Ô∏è Pumice is made of bubbles ‚Äî lava cooled so quickly it kept the air inside, making a rock that floats like a sponge of stone.",
              ]
          },
      
          sedimentaryRocks: {
              words: ['SEDIMENTARY', 'SEDIMENT', 'CLASTIC', 'CHEMICAL', 'ORGANIC', 'CALICHE', 'PUDDINGSTONE', 'CHALK', 'LIMESTONE', 'CHERT', 'COAL', 'CONGLOMERATE', 'COQUINA', 'FOSSIL', 'DIATOMITE', 'DOLOMITE', 'FLINT', 'ROCK SALT', 'SANDSTONE', 'SHALE', 'SILTSTONE', 'CEMENTATION', 'DETRITUS', 'STRATA', 'BEDDING', 'SEDIMENTOLOGY', 'GRAVEL', 'SAND', 'MUD', 'SILT', 'CLAY', 'BRECCIA', 'MUDROCK', 'EVAPORITE', 'COMPACTION', 'LITHIFICATION', 'DIAGENESIS', 'LAMINATION', 'DUNE', 'RIPPLE', 'BIOTURBATION', 'MATRIX'],
              facts: [
                  "üåç Sedimentary rocks are storytellers ‚Äî made in three ways: from fragments, from minerals, or from once-living things.",
                  "ü™∂ These rocks form slowly as layers of tiny pieces settle and are gently pressed into stone over time.",
                  "ü™∫ Sediments can come from broken stone or living things left behind ‚Äî bits of yesterday turned into tomorrow.",
                  "üçÉ Geological debris is born from weathered cliffs and crumbled mountains, carried by wind, water, or time.",
                  "üìö Sedimentary rock covers most of the land we walk on, though it's only a thin crust atop the deeper Earth.",
                  "üìñ These rocks stack in layers called strata ‚Äî soft pages in the ancient book of the world.",
                  "üõ∏ Even Mars, dusty and distant, holds sedimentary rocks ‚Äî proof that water once moved across its face.",
                  "üå± From coal to drinking water, sedimentary rocks are quiet holders of treasures we rely on every day.",
                  "üß© Clastic rocks are built from puzzle pieces of older stones, pressed and glued together by pressure and patience.",
                  "üåæ Loose sediments are named by size ‚Äî gravel clatters, sand sighs, and mud smooths into stillness.",
                  "üêö Many limestones are made from the bones of ocean life ‚Äî coral, mollusks, and tiny drifting creatures.",
                  "üå≤ Coal is ancient vegetation, transformed by time and pressure into a rock that still remembers leaves and light.",
                  "üî¨ Chert forms from the skeletons of microscopic ocean folk ‚Äî radiolaria and diatoms, hidden but enduring.",
                  "üåÄ Diagenesis is the slow magic of change beneath the surface ‚Äî transformation without a single breath of air.",
                  "üåä Coquina is made entirely of broken shells, and can only be born where the waves never rest.",
                  "ü¶¥ Fossils are most often found in sedimentary stone ‚Äî each one a memory cradled in ancient silt.",
                  "‚è≥ A fossil‚Äôs best chance comes in places where sediment settles quickly and few bacteria sleep.",
                  "üêæ Footprints, burrows, and other marks left behind are called trace fossils ‚Äî echoes of movement and life.",
                  "üåä Ripple marks form where water flows ‚Äî in rivers, on beaches, or in the quiet shifts of tidal flats."
              ]
          },
          
          metamorphicRocks: {
              words: ['METAMOPRHIC', 'FOLIATION', 'ANTHRACITE', 'GNEISS', 'HORNFELS', 'LAPIS LAZULI', 'MARBLE', 'MARIPOSITE', 'NOVACULITE', 'PHYLLITE', 'QUARTZITE', 'SCHIST', 'SKARN', 'SLATE', 'SOAPSTONE', 'METAMORPHISM', 'PROTOLITH', 'INDEX MINERAL', 'THERMAL', 'CATACLASTIC', 'HYDROTHERMAL', 'IMPACT', 'FISSILITY'],
              facts: [
                  "üåÄ Metamorphic rocks are born from change ‚Äî when older stones are transformed by heat, pressure, and time into something entirely new.",
                  "üìú The rock before the change is called a protolith ‚Äî it might be volcanic, sedimentary, or already a stone shaped by change once before.",
                  "üåç Some rocks are changed deep within the Earth, others by the slow press of tectonic plates ‚Äî all shaped in the hidden chambers beneath our feet.",
                  "üíé Certain minerals, called index minerals, act like timekeepers ‚Äî revealing how hot and how deep a rock‚Äôs transformation truly went.",
                  "üîç Metamorphic rocks often sparkle with larger crystals than they began with ‚Äî time and pressure coaxed them to grow.",
                  "üìö Many metamorphic stones wear stripes or layers called foliation ‚Äî a record of stress folded into every line.",
                  "üî≤ We name these rocks by their texture and how clearly their layers show ‚Äî some whisper their history, while others shout.",
                  "üî• When magma creeps too close, it can bake nearby stone ‚Äî creating a rim of changed rock through contact metamorphism.",
                  "‚è≥ Some of Earth‚Äôs oldest stones are metamorphic ‚Äî like the Acasta Gneiss in Canada, which remembers the world over 4 billion years ago.",
                  "ü™µ Slate breaks in smooth, even sheets ‚Äî a gift of structure that made it perfect for roofs, tiles, and chalkboard days.",
                  "üé® Marble begins as limestone or dolomite, but metamorphosis polishes it into sculpture-ready stone, luminous and strong.",
                  "‚ö†Ô∏è Schist has pronounced lines of weakness ‚Äî beautiful, yes, but tricky for those building upon it.",
                  "ü™ì Quartzite began as sandstone ‚Äî but time‚Äôs pressure turned it so tough that early humans shaped tools from its unyielding surface.",
                  "‚ö° Slate, being a fine insulator, once guarded the earliest electric switchboards ‚Äî keeping sparks at bay with quiet grace.",
                  "üî• Soapstone, soft and smooth, was carved by Native Americans into bowls, pipes, and ornaments thousands of years ago.",
                  "‚õèÔ∏è Soapstone was one of the first stones humans quarried ‚Äî rising close to the surface, asking only to be shaped.",
                  "üåü In the Gold Rush days, prospectors learned to follow the glitter in mariposite ‚Äî a green stone often veined with promise."
              ]
          },
        };

        const wordlingThemes = {
            fruits: ['wordling1.png', 'wordling2.png', 'wordling3.png', 'wordling4.png'],
            domesticAnimals: ['wordling1.png', 'wordling2.png', 'wordling3.png', 'wordling4.png'], // reuse is fine!
            cozy: ['cozy-wordling1.png', 'cozy-wordling2.png'], 
            gemstones: ['gem-wordling1.png', 'gem-wordling2.png', 'gem-wordling3.png', 'gem-wordling4.png'],
            miku: ['miku-wordling1.png', 'miku-wordling2.png', 'miku-wordling3.png'],
            mikusongs: ['miku-wordling1.png', 'miku-wordling2.png', 'miku-wordling3.png'],
            igneousRocks: ['gem-wordling1.png', 'gem-wordling2.png', 'gem-wordling3.png', 'gem-wordling4.png', 'igneous-wordling.png'],
            sedimentaryRocks: ['gem-wordling1.png', 'gem-wordling2.png', 'gem-wordling3.png', 'gem-wordling4.png', 'sedimentary-wordling.png'],
            metamorphicRocks: ['gem-wordling1.png', 'gem-wordling2.png', 'gem-wordling3.png', 'gem-wordling4.png', 'metamorphic-wordling.png']
            // add more as you build more puzzles
        };

      const cosplayWordlings = [
        'pokeling.png',
        'dekuling.png',
        'moonling.png',
        'gokuling.png',
        'cloudling.png',
        'ceciling.png',
        'squalling.png',
        'terraling.png',
        'warrioroflightling.png',
        'zidaneling.png',
      ];

        const grid = [];
        let gridSize = 10;
        let words = [];
        let currentPuzzleTheme = 'fruits'; // default
        let bonusWord = ''; // The hidden word
        let korokCount = 0;
        const cellElements = [];
        const directions = [
            [0, 1], [1, 0], [1, 1], [-1, 1]
        ];
        let selectedCells = [];
        let isMouseDown = false;
        let selecting = false;
        let floatingWordling = null;
        let floatingWordlingImage = null;
        let unlockedCosplays = [];

        const gridShell = document.getElementById('grid-shell');

        if (gridSize >= 12 && window.innerWidth < 600) {
          gridShell.classList.add('show-scroll');
        } else {
          gridShell.classList.remove('show-scroll');
        }

        if (gridSize >= 12) {
          document.querySelectorAll('.cell').forEach(cell => cell.classList.add('big-grid'));
        }
        if (gridSize === 12) {
          document.getElementById('grid-container').classList.add('zoom-out');
        }
  
        function createEmptyGrid() {
            for (let i = 0; i < gridSize; i++) {
                grid[i] = [];
                cellElements[i] = [];
                for (let j = 0; j < gridSize; j++) {
                grid[i][j] = '';
                cellElements[i][j] = null;
                }
            }
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function getCellData(el) {
            return {
                element: el,
                letter: el.textContent,
                row: parseInt(el.dataset.row),
                col: parseInt(el.dataset.col)
            };
        }

        function tryPlacingWords(wordList, maxWords = 12) {
            const placed = [];
            const copy = [...wordList];
            shuffle(copy);
        
            for (let originalWord of copy) {
                const cleanWord = originalWord.replace(/\s+/g, '').toUpperCase();
        
                if (cleanWord.length > gridSize) continue; // skip overly long words
                if (placed.length >= maxWords) break;
        
                if (placeWord(cleanWord)) {
                    placed.push({ display: originalWord, value: cleanWord });
                }
            }
        
            // üåü Add a hidden bonus word (guaranteed)!
            const allWords = wordList.filter(w => !placed.some(p => p.display === w));
            bonusWord = ''; // reset before attempting placement
        
            for (let i = 0; i < allWords.length; i++) {
                const candidate = allWords[i].replace(/\s+/g, '').toUpperCase();
                if (!placed.some(p => p.value === candidate) && placeWord(candidate)) {
                    bonusWord = candidate;
                    break;
                }
            }
        
            // ü™Ñ Optional backup: reuse a placed word if nothing else fits
            if (!bonusWord && placed.length > 0) {
                const fallback = placed[Math.floor(Math.random() * placed.length)];
                bonusWord = fallback.value;
            }
        
            return placed;
        }

        function generatePuzzle() {
            document.getElementById('congrats-overlay').style.display = 'none';
            document.getElementById('interaction-blocker').style.display = 'none';
            document.getElementById('grid').classList.remove('grid-disabled'); 
          
            const sizeValue = document.getElementById('size-select').value;
            const listValue = document.getElementById('wordlist-select').value;
            currentPuzzleTheme = listValue; // store the theme globally
            const wordListObj = wordLists[listValue];

            const wordList = wordListObj.words;
            const facts = wordListObj.facts;

            const randomFact = facts[Math.floor(Math.random() * facts.length)];
            document.getElementById('puzzle-fact').textContent = `${randomFact}`;

            document.getElementById('hidden-word-value').textContent = '(still hiding...)';
            if (floatingWordling) {
              floatingWordling.remove();
              floatingWordling = null;
              floatingWordlingImage = null;
            }

            gridSize = parseInt(sizeValue);

            selectedCells = [];
            selectedCells.direction = null;

            createEmptyGrid();
            const maxWords = Math.floor(gridSize * 0.8); // scale with grid size
            words = tryPlacingWords(wordList, maxWords);
            fillEmptyCells();
            renderWordList();
            renderGrid();

            console.log("Placed words:", words.map(w => w.display));
            console.log("Bonus word:", bonusWord);
        }
  
        function placeWord(word) {
            for (let attempts = 0; attempts < 100; attempts++) {
                const dir = directions[Math.floor(Math.random() * directions.length)];
                const row = Math.floor(Math.random() * gridSize);
                const col = Math.floor(Math.random() * gridSize);
        
                let fits = true;
                for (let i = 0; i < word.length; i++) {
                const r = row + dir[0] * i;
                const c = col + dir[1] * i;
                if (r < 0 || r >= gridSize || c < 0 || c >= gridSize || (grid[r][c] && grid[r][c] !== word[i])) {
                    fits = false;
                    break;
                }
                }
        
                if (fits) {
                for (let i = 0; i < word.length; i++) {
                    const r = row + dir[0] * i;
                    const c = col + dir[1] * i;
                    grid[r][c] = word[i];
                }
                return true;
                }
            }
            return false;
        }
  
        function fillEmptyCells() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                if (!grid[i][j]) {
                    grid[i][j] = letters[Math.floor(Math.random() * letters.length)];
                    }
                }
            }
        }
  
        function renderWordList() {
            const listDiv = document.getElementById('word-list');
            listDiv.innerHTML = '<strong>Find these words:</strong><br>' +
                words.map(w => `<span id="word-${w.value}">${w.display}</span>`).join(', ');
        }
  
        function renderGrid() {
            const gridDiv = document.getElementById('grid');
            gridDiv.innerHTML = '';
            gridDiv.style.gridTemplateColumns = `repeat(${gridSize}, 30px)`; // <-- this fixes it!

            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                const cell = document.createElement('div');
                cell.textContent = grid[i][j];
                cell.className = 'cell';
                cell.dataset.row = i;
                cell.dataset.col = j;

                cell.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    isMouseDown = true;
                    clearSelection();
                    selectCell(cell);
                });

                cell.addEventListener('mouseenter', () => {
                    if (isMouseDown) selectCell(cell);
                });

                cell.addEventListener('mouseup', () => {
                    isMouseDown = false;
                    checkSelectedWord();
                });

                cell.addEventListener('touchstart', handleTouchStart, { passive: false });
                cell.addEventListener('touchmove', handleTouchMove, { passive: false });
                cell.addEventListener('touchend', handleTouchEnd);

                gridDiv.appendChild(cell);
                cellElements[i][j] = cell;
                }
            }

            document.body.addEventListener('mouseup', () => {
                isMouseDown = false;
                checkSelectedWord();
            });
        }

        function handleTouchStart(e) {
          e.preventDefault();
          const target = e.target.closest('.cell');
          if (target) {
            selecting = true;
            clearSelection(); // üî• reset any previous selection
            selectCell(target);
          }
        }

        function handleTouchMove(e) {
          e.preventDefault();
          const touch = e.touches[0];
          const target = document.elementFromPoint(touch.clientX, touch.clientY);
          if (target && target.classList.contains('cell') && selecting) {
            selectCell(target); // üî• Use your core function!
          }
        }

        function handleTouchEnd(e) {
          if (selecting) {
            selecting = false;
            checkSelectedWord();
            clearSelection();
            selectedCells = [];
          }
        }
  
        function selectCell(cell) {
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            const last = selectedCells[selectedCells.length - 1];

            // Start with first cell
            if (!last) {
                cell.classList.add('selected');
                selectedCells.push({ row, col, letter: grid[row][col], element: cell });
                return;
            }

            // Undo/backtrack if dragging over previous cell
            if (
                selectedCells.length > 1 &&
                row === selectedCells[selectedCells.length - 2].row &&
                col === selectedCells[selectedCells.length - 2].col
            ) {
                last.element.classList.remove('selected');
                selectedCells.pop();
                return;
            }

            // Already selected elsewhere: ignore
            if (selectedCells.some(c => c.row === row && c.col === col)) return;

            // Lock direction from first two cells
            if (selectedCells.length === 1) {
                const dRow = row - last.row;
                const dCol = col - last.col;
                if ((dRow === 0 && dCol === 0) || Math.abs(dRow) > 1 || Math.abs(dCol) > 1) return;

                selectedCells.direction = [dRow, dCol];
            } else if (selectedCells.direction) {
                // Allow small error margin for direction
                const expectedRow = last.row + selectedCells.direction[0];
                const expectedCol = last.col + selectedCells.direction[1];

                const rowDiff = Math.abs(expectedRow - row);
                const colDiff = Math.abs(expectedCol - col);

                if (rowDiff > 0.2 || colDiff > 0.2) return; // allow slight error
            }

            // Save the original background color so we can restore it
            const previousColor = cell.style.backgroundColor;
            
            cell.classList.add('selected');
            cell.dataset.prevColor = previousColor || ''; // store inline color if any
            cell.style.backgroundColor = ''; // let CSS handle the selected style
            selectedCells.push({ row, col, letter: grid[row][col], element: cell });
        }
        
        function clearSelection() {
            selectedCells.forEach(cell => {
              cell.element.classList.remove('selected');
              if (cell.element.dataset.prevColor) {
                cell.element.style.backgroundColor = cell.element.dataset.prevColor;
                delete cell.element.dataset.prevColor;
              }
            });
            selectedCells = [];
            selectedCells.direction = null; // Reset direction
        }

        function getRandomPastel() {
            const hue = Math.floor(Math.random() * 360);
            return `hsl(${hue}, 70%, 85%)`; // pastel-like
        }

        function createImageWordling(size = 48, theme = 'fruits', returnImageOnly = true) {
            const army = wordlingThemes[theme] || ['wordling1.png'];
            const chosen = army[Math.floor(Math.random() * army.length)];
        
            const img = document.createElement('img');
            img.src = `images/${chosen}`;
            img.alt = 'Wordling';
            img.className = 'wordling-img';
            img.style.width = `${size}px`;
        
            return returnImageOnly ? img : { img, chosen };
        }

        function showWordlingPop(imageFile) {
          // Remove any existing pop-up
          const old = document.getElementById('label-wordling');
          if (old) old.remove();
        
          const label = document.getElementById('hidden-word-value');
          const wordling = document.createElement('img');
          wordling.src = `images/${imageFile}`;
          wordling.classList.add('wordling-pop');
          wordling.id = 'label-wordling';
        
          const labelBox = label.getBoundingClientRect();
        
          // üõ†Ô∏è Define the offsets before using them
          const offsetX = labelBox.left + window.scrollX + labelBox.width + 10;
          const offsetY = labelBox.top + window.scrollY - 10;
        
          wordling.style.left = `${offsetX}px`;
          wordling.style.top = `${offsetY}px`;
        
          document.body.appendChild(wordling);
        
          // Track it
          floatingWordling = wordling;
          floatingWordlingImage = imageFile;
        
          // üéâ Confetti!
          confetti({
            particleCount: 30,
            spread: 60,
            startVelocity: 25,
            origin: {
              x: offsetX / window.innerWidth,
              y: offsetY / window.innerHeight
            }
          });
        }

        function unlockCosplayWordling() {
          const emptyMsg = document.getElementById('cosplay-empty');
          if (emptyMsg) emptyMsg.style.display = 'none';
          
          const available = cosplayWordlings.filter(w => !unlockedCosplays.includes(w));
          if (available.length === 0) return; // all unlocked
        
          const chosen = available[Math.floor(Math.random() * available.length)];
          unlockedCosplays.push(chosen);
        
          const cosplayImg = document.createElement('img');
          cosplayImg.src = `images/${chosen}`;
          cosplayImg.alt = 'Cosplay Wordling';
          cosplayImg.className = 'wordling-img';
          cosplayImg.style.height = '64px';
          cosplayImg.style.margin = '4px';
        
          document.getElementById('cosplay-section').appendChild(cosplayImg);
        
          // Optional: Add message pop-up
          //alert('üéâ You unlocked a Cosplay Wordling!');
        }

        function showKorok() {
            const existingPop = document.getElementById('label-wordling');
            if (existingPop) existingPop.remove();
        
            if (bonusWord) {
                document.getElementById('hidden-word-value').textContent = bonusWord;
            }
        
            const { chosen } = createImageWordling(48, currentPuzzleTheme, false);
            showWordlingPop(chosen); // just shows it ‚Äî we‚Äôll move it later
        }
  
        function checkSelectedWord() {
            if (selectedCells.length === 0) return;
            const word = selectedCells.map(c => c.letter).join('');
            const reversed = word.split('').reverse().join('');

            const match = words.find(w => w.value === word || w.value === reversed);
            const isBonus = word === bonusWord || reversed === bonusWord;

            if (match || isBonus) {
                const pastel = getRandomPastel();
                selectedCells.forEach(c => {
                    c.element.style.backgroundColor = pastel;
                    c.element.classList.add('found');
                });

                if (match) {
                    document.getElementById(`word-${match.value}`).classList.add('found-word');
                }

                if (isBonus) {
                    showKorok();
                }

                checkIfPuzzleComplete();
            }

            clearSelection();
        }

        function moveLabelWordlingToRow() {
          const emptyMsg = document.getElementById('army-empty');
          if (emptyMsg) emptyMsg.style.display = 'none';
          
          if (!floatingWordling || !floatingWordlingImage) return;
        
          // Clean up the label Wordling
          floatingWordling.removeAttribute('id');
          floatingWordling.classList.remove('wordling-pop');
          floatingWordling.classList.add('wordling-row-img');
          floatingWordling.removeAttribute('style');
        
          const row = document.getElementById('wordling-row');
        
          row.appendChild(floatingWordling);

            // ‚úÖ Increment the count ONLY when Wordling actually joins
          korokCount++;
          document.getElementById('korok-count').textContent = korokCount;
        
          // ‚úÖ Check for cosplay unlocks too
          if (korokCount % 5 === 0) {
            unlockCosplayWordling();
          }
        
          // Clear the reference after moving
          floatingWordling = null;
          floatingWordlingImage = null;
        }
        

        function checkIfPuzzleComplete() {
            const found = document.querySelectorAll('.found-word').length;
            if (found === words.length) {
                document.getElementById('congrats-overlay').style.display = 'flex';
                launchConfetti(); // üéâ Right here!
                moveLabelWordlingToRow(); // üåü move the Wordling to the row
                document.getElementById('grid').classList.add('grid-disabled');
                document.getElementById('interaction-blocker').style.display = 'block';
            }
        }

        function launchConfetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { x: 0.5, y: 0.5 }
            });
        }
  
        // Run the game
        document.getElementById('new-game-btn').addEventListener('click', generatePuzzle);
        generatePuzzle(); // initial load
    
    </script>
</body>
</html>
